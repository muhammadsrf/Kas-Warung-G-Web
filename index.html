<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kas Warung</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 300px; max-height: 40vh; }
        @media (min-width: 768px) {
            .chart-container { height: 350px; max-height: 50vh; }
        }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 50;
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-content::-webkit-scrollbar { width: 8px; }
        .modal-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb { background: #c5c5c5; border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb:hover { background: #a5a5a5; }
        .gemini-btn-loading {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .gemini-btn-loading::after {
            content: '...';
            display: inline-block;
            animation: ellipsis 1.25s infinite;
        }
        @keyframes ellipsis {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        
        .print-only { display: none; } 

        @media print {
            body > *:not(.print-only) { 
                display: none !important;
            }
            .modal-backdrop.hidden { 
                 display: none !important;
            }
             .modal-backdrop:not(.hidden) { 
                display: none !important;
            }

            .print-only {
                display: block !important;
                visibility: visible !important;
                position: static; 
                width: 100%; 
                margin: 0 auto; 
                padding: 10px;
                font-size: 10pt;
                line-height: 1.3;
                color: #000 !important;
                background: #fff !important; 
            }
            .print-only * {
                visibility: visible !important;
                color: #000 !important; 
                background: transparent !important; 
                font-size: inherit !important; 
                line-height: inherit !important;
            }
            .print-only h3, .print-only h4 {
                font-weight: bold;
                margin-top: 5px;
                margin-bottom: 2px;
            }
            .print-only table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 5px;
                margin-bottom: 5px;
            }
            .print-only th, .print-only td {
                border-bottom: 1px dashed #ccc;
                padding: 3px 1px; 
                text-align: left;
            }
            .print-only th:last-child, .print-only td:last-child {
                text-align: right;
            }
             .print-only td:nth-child(2) { 
                text-align: center;
            }
            .print-only .receipt-footer {
                margin-top: 10px;
                text-align: center;
                font-size: 9pt;
            }
            .no-print {
                display: none !important;
            }
        }
        #barcodeScannerViewport video, #barcodeScannerViewport canvas {
            width: 100% !important;
            height: auto !important;
        }
        #barcodeScannerViewport canvas.drawingBuffer {
             position: absolute;
             top: 0;
             left: 0;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="flex h-screen bg-slate-100 no-print">
        <aside class="w-20 lg:w-64 bg-white shadow-md flex flex-col items-center lg:items-start p-4 transition-all duration-300">
            <div class="flex items-center justify-center lg:justify-start w-full mb-10">
                 <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl">W</div>
                 <h1 class="text-xl font-bold ml-3 hidden lg:block">Kas Warung</h1>
            </div>
            <nav class="flex flex-col space-y-2 w-full">
                <a href="#dashboard" class="nav-link active flex items-center p-3 rounded-lg text-slate-700 bg-blue-100 font-semibold" data-target="dashboard">
                    <span class="text-xl">üìä</span><span class="ml-4 hidden lg:block">Dashboard</span>
                </a>
                <a href="#kasir" class="nav-link flex items-center p-3 rounded-lg text-slate-700 hover:bg-blue-50" data-target="kasir">
                    <span class="text-xl">üõí</span><span class="ml-4 hidden lg:block">Kasir</span>
                </a>
                <a href="#produk" class="nav-link flex items-center p-3 rounded-lg text-slate-700 hover:bg-blue-50" data-target="produk">
                    <span class="text-xl">üì¶</span><span class="ml-4 hidden lg:block">Produk</span>
                </a>
                <a href="#pelanggan" class="nav-link flex items-center p-3 rounded-lg text-slate-700 hover:bg-blue-50" data-target="pelanggan">
                    <span class="text-xl">üë•</span><span class="ml-4 hidden lg:block">Pelanggan</span>
                </a>
                <a href="#keuangan" class="nav-link flex items-center p-3 rounded-lg text-slate-700 hover:bg-blue-50" data-target="keuangan">
                    <span class="text-xl">üí∞</span><span class="ml-4 hidden lg:block">Keuangan</span>
                </a>
                <a href="#laporan" class="nav-link flex items-center p-3 rounded-lg text-slate-700 hover:bg-blue-50" data-target="laporan">
                    <span class="text-xl">üìà</span><span class="ml-4 hidden lg:block">Laporan</span>
                </a>
                <a href="#pengaturan" class="nav-link flex items-center p-3 rounded-lg text-slate-700 hover:bg-blue-50" data-target="pengaturan">
                    <span class="text-xl">‚öôÔ∏è</span><span class="ml-4 hidden lg:block">Pengaturan</span>
                </a>
            </nav>
        </aside>

        <main class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
            
            <section id="dashboard" class="page-content active">
                <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="text-sm font-medium text-slate-500">Penjualan Hari Ini</h3>
                        <p id="penjualanHariIniEl" class="text-3xl font-bold text-blue-600 mt-2">Rp 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="text-sm font-medium text-slate-500">Laba Kotor Hari Ini</h3>
                        <p id="labaHariIniEl" class="text-3xl font-bold text-green-600 mt-2">Rp 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="text-sm font-medium text-slate-500">Transaksi Hari Ini</h3>
                        <p id="transaksiHariIniEl" class="text-3xl font-bold text-emerald-600 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="text-sm font-medium text-slate-500">Produk Terlaris Hari Ini</h3>
                        <p id="produkTerlarisEl" class="text-2xl font-bold mt-2">-</p>
                        <button id="generatePromotionBtn" class="mt-3 text-sm bg-purple-100 text-purple-700 px-3 py-1.5 rounded-lg hover:bg-purple-200 transition disabled:opacity-50 disabled:cursor-not-allowed">‚ú® Ide Promosi Produk Ini</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="text-sm font-medium text-slate-500">Total Piutang</h3>
                        <p id="totalPiutangEl" class="text-3xl font-bold text-amber-600 mt-2">Rp 0</p>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="text-sm font-medium text-slate-500">Pengeluaran Hari Ini</h3>
                        <p id="pengeluaranHariIniDashboardEl" class="text-3xl font-bold text-red-500 mt-2">Rp 0</p>
                    </div>
                </div>
                <div id="promotionIdeasContainer" class="mb-6"></div>
                <div class="bg-white p-6 rounded-xl shadow mb-6">
                    <h3 class="text-lg font-semibold mb-4">Tren Penjualan & Laba 7 Hari Terakhir</h3>
                    <div class="chart-container">
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow">
                         <h3 class="text-lg font-semibold mb-4">Stok Segera Habis</h3>
                         <ul id="stokKritisList" class="space-y-3">
                             <li class="text-slate-400">Tidak ada stok kritis.</li>
                         </ul>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow">
                         <h3 class="text-lg font-semibold mb-4">Transaksi Terakhir</h3>
                         <ul id="transaksiTerakhirList" class="space-y-3">
                            <li class="text-slate-400">Belum ada transaksi.</li>
                         </ul>
                    </div>
                </div>
            </section>

            <section id="kasir" class="page-content hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                    <div class="lg:col-span-2 bg-white rounded-xl shadow p-6 h-[calc(100vh-10rem)] sm:h-[85vh] flex flex-col">
                        <div class="flex flex-col sm:flex-row gap-4 mb-4 items-center">
                            <input id="searchInput" type="text" placeholder="Cari produk..." class="w-full sm:flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <select id="categoryFilter" class="w-full sm:w-auto p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none mr-auto sm:mr-2">
                                <option value="all">Semua Kategori</option>
                            </select>
                            <button id="scanBarcodeBtn" class="bg-indigo-500 text-white px-4 py-3 rounded-lg font-semibold hover:bg-indigo-600 transition whitespace-nowrap w-full sm:w-auto">üì∑ Scan Barcode</button>
                            <button id="addCustomTransactionBtn" class="bg-sky-500 text-white px-4 py-3 rounded-lg font-semibold hover:bg-sky-600 transition whitespace-nowrap w-full sm:w-auto mt-2 sm:mt-0">‚ûï Transaksi Kustom</button>
                        </div>
                        <div id="productList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 overflow-y-auto flex-1 p-2">
                        </div>
                    </div>
                    <div class="lg:col-span-1 bg-white rounded-xl shadow p-6 h-[calc(100vh-10rem)] sm:h-[85vh] flex flex-col">
                        <h3 class="text-xl font-bold mb-4">Keranjang</h3>
                        <div id="cartItems" class="flex-1 overflow-y-auto border-y py-4 space-y-3">
                            <p class="text-slate-400 text-center">Keranjang masih kosong.</p>
                        </div>
                        <div class="mt-4 pt-4 border-t">
                            <div class="flex justify-between text-lg font-semibold mb-4">
                                <span>Total</span>
                                <span id="cartTotal">Rp 0</span>
                            </div>
                            <button id="payButton" class="w-full bg-blue-600 text-white p-4 rounded-lg font-bold text-lg hover:bg-blue-700 transition disabled:bg-slate-300">
                                Bayar
                            </button>
                        </div>
                    </div>
                 </div>
            </section>

            <section id="produk" class="page-content hidden">
                 <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold">Manajemen Produk</h2>
                    <div class="flex gap-4">
                        <button id="manageCategoriesBtn" class="bg-green-600 text-white px-5 py-2.5 rounded-lg font-semibold hover:bg-green-700 transition">Kelola Kategori</button>
                        <button id="addProductBtn" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg font-semibold hover:bg-blue-700 transition">Tambah Produk</button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow overflow-x-auto">
                    <table class="w-full text-left min-w-[600px]">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-4 font-semibold">Nama Produk</th>
                                <th class="p-4 font-semibold">Kategori</th>
                                <th class="p-4 font-semibold">Kode Barcode</th>
                                <th class="p-4 font-semibold">Harga Beli</th>
                                <th class="p-4 font-semibold">Harga Jual</th>
                                <th class="p-4 font-semibold">Stok</th>
                                <th class="p-4 font-semibold">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="pelanggan" class="page-content hidden">
                <div class="flex justify-between items-center mb-6">
                   <h2 class="text-2xl font-bold">Manajemen Pelanggan</h2>
                   <button id="addCustomerBtn" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg font-semibold hover:bg-blue-700 transition">Tambah Pelanggan</button>
               </div>
               <div class="bg-white rounded-xl shadow overflow-x-auto">
                   <table class="w-full text-left min-w-[600px]">
                       <thead class="bg-slate-100">
                           <tr>
                               <th class="p-4 font-semibold">Nama Pelanggan</th>
                               <th class="p-4 font-semibold">Telepon</th>
                               <th class="p-4 font-semibold">Alamat</th>
                               <th class="p-4 font-semibold text-right">Saldo Hutang</th>
                               <th class="p-4 font-semibold">Aksi</th>
                           </tr>
                       </thead>
                       <tbody id="customerTableBody">
                       </tbody>
                   </table>
               </div>
           </section>

            <section id="keuangan" class="page-content hidden">
                <h2 class="text-2xl font-bold mb-6">Manajemen Keuangan</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="text-sm font-medium text-slate-500">Total Pemasukan (Penjualan & Bayar Hutang)</h3>
                        <p id="financeTotalRevenue" class="text-2xl font-bold text-green-600 mt-1">Rp 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="text-sm font-medium text-slate-500">Total Pengeluaran</h3>
                        <p id="financeTotalExpenses" class="text-2xl font-bold text-red-500 mt-1">Rp 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="text-sm font-medium text-slate-500">Estimasi Laba Bersih</h3>
                        <p id="financeNetProfit" class="text-2xl font-bold text-blue-600 mt-1">Rp 0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="text-xl font-semibold mb-4">Catat Pengeluaran Baru</h3>
                        <form id="addExpenseForm" class="space-y-4">
                            <div>
                                <label for="expenseDate" class="block text-sm font-medium text-slate-700 mb-1">Tanggal</label>
                                <input type="date" id="expenseDate" class="w-full p-3 border rounded-lg" required>
                            </div>
                            <div>
                                <label for="expenseDescription" class="block text-sm font-medium text-slate-700 mb-1">Deskripsi Pengeluaran</label>
                                <input type="text" id="expenseDescription" class="w-full p-3 border rounded-lg" placeholder="cth: Belanja Stok Sabun" required>
                            </div>
                            <div>
                                <label for="expenseAmount" class="block text-sm font-medium text-slate-700 mb-1">Jumlah (Rp)</label>
                                <input type="number" id="expenseAmount" class="w-full p-3 border rounded-lg" required min="0">
                            </div>
                            <button type="submit" class="w-full bg-rose-500 text-white p-3 rounded-lg font-bold hover:bg-rose-600 transition">Tambah Pengeluaran</button>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="text-xl font-semibold mb-4">Daftar Pengeluaran (10 Terakhir)</h3>
                        <div class="overflow-x-auto max-h-96">
                            <table class="w-full text-left min-w-[400px]">
                                <thead class="bg-slate-100 sticky top-0">
                                    <tr>
                                        <th class="p-3 font-semibold">Tanggal</th>
                                        <th class="p-3 font-semibold">Deskripsi</th>
                                        <th class="p-3 font-semibold text-right">Jumlah</th>
                                    </tr>
                                </thead>
                                <tbody id="expenseListTableBody">
                                    <tr><td colspan="3" class="p-4 text-center text-slate-500">Belum ada pengeluaran.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="laporan" class="page-content hidden">
                <h2 class="text-2xl font-bold mb-6">Laporan</h2>
                 <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4">Laporan Penjualan & Laba per Kategori</h3>
                    <div class="bg-white p-6 rounded-xl shadow mb-6">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 mb-4">
                            <div>
                                <label for="reportPeriod" class="font-medium">Periode:</label>
                                <select id="reportPeriod" class="p-2 border rounded-lg">
                                    <option value="daily">Harian</option>
                                    <option value="weekly">Mingguan</option>
                                    <option value="monthly">Bulanan</option>
                                </select>
                            </div>
                            <div>
                                <label for="reportDate" class="font-medium">Tanggal:</label>
                                <input type="date" id="reportDate" class="p-2 border rounded-lg">
                            </div>
                        </div>
                         <div class="chart-container" style="height: 350px;">
                            <canvas id="salesReportChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Detail Transaksi Periode Terpilih</h3>
                            <button id="exportReportBtn" class="bg-emerald-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-emerald-600 transition text-sm">üìÑ Ekspor Detail ke CSV</button>
                        </div>
                        <div id="reportDetailsTableContainer" class="overflow-x-auto">
                            <p class="text-slate-500">Pilih periode dan tanggal untuk melihat detail.</p>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-semibold mb-4">Laporan Piutang Pelanggan</h3>
                    <div class="bg-white p-6 rounded-xl shadow overflow-x-auto">
                        <table class="w-full text-left min-w-[500px]">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th class="p-4 font-semibold">Nama Pelanggan</th>
                                    <th class="p-4 font-semibold">Telepon</th>
                                    <th class="p-4 font-semibold text-right">Total Hutang</th>
                                </tr>
                            </thead>
                            <tbody id="piutangTableBody">
                                <tr><td colspan="3" class="p-4 text-center text-slate-500">Tidak ada piutang.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="pengaturan" class="page-content hidden">
                <h2 class="text-2xl font-bold mb-6">Pengaturan</h2>
                <div class="bg-white p-8 rounded-xl shadow max-w-2xl mx-auto">
                    <h3 class="text-lg font-semibold mb-6">Informasi Warung</h3>
                    <form id="settingsForm" class="space-y-6 mb-8">
                        <div>
                            <label for="shopName" class="block text-sm font-medium text-slate-700 mb-1">Nama Warung</label>
                            <input type="text" id="shopName" value="Warung Sejahtera" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                         <div>
                            <label for="shopAddress" class="block text-sm font-medium text-slate-700 mb-1">Alamat</label>
                            <input type="text" id="shopAddress" value="Jl. Merdeka No. 17, Jakarta" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                         <div>
                            <label for="shopPhone" class="block text-sm font-medium text-slate-700 mb-1">No. Telepon</label>
                            <input type="text" id="shopPhone" value="081234567890" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div class="pt-4">
                            <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition">Simpan Informasi Warung</button>
                        </div>
                    </form>
                     <div id="settingsMessage" class="mt-4 text-center"></div>

                    <hr class="my-8">
                     <h3 class="text-lg font-semibold mb-6">Pengaturan API Key Gemini</h3>
                     <div class="space-y-4 mb-8">
                        <div>
                            <label for="geminiApiKeyInput" class="block text-sm font-medium text-slate-700 mb-1">API Key Gemini Anda</label>
                            <div class="flex gap-3">
                                <input type="password" id="geminiApiKeyInput" placeholder="Masukkan API Key Gemini Anda" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                <button id="saveGeminiApiKeyBtn" class="bg-purple-600 text-white px-5 py-3 rounded-lg font-semibold hover:bg-purple-700 transition">Simpan Key</button>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">API Key ini disimpan di localStorage browser Anda. Jaga kerahasiaannya.</p>
                        </div>
                     </div>


                    <hr class="my-8">

                    <h3 class="text-lg font-semibold mb-6">Manajemen Data Aplikasi</h3>
                    <div class="space-y-4 mb-8">
                        <div>
                            <button id="backupDataBtn" class="w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 transition">Backup Data Aplikasi</button>
                            <p class="text-xs text-slate-500 mt-1">Unduh semua data aplikasi (produk, pelanggan, transaksi, dll.) sebagai file JSON.</p>
                        </div>
                        <div>
                            <label for="restoreFile" class="block text-sm font-medium text-slate-700 mb-1">Restore Data Aplikasi dari File</label>
                            <input type="file" id="restoreFile" accept=".json" class="w-full p-2 border rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                             <p class="text-xs text-slate-500 mt-1">Pilih file backup JSON untuk me-restore data. PERHATIAN: Data saat ini akan diganti.</p>
                        </div>
                    </div>
                    <hr class="my-8">
                     <h3 class="text-lg font-semibold mb-6">Status Penyimpanan Lokal</h3>
                     <div class="bg-slate-100 p-4 rounded-lg">
                        <p class="text-sm text-slate-700">Estimasi Penggunaan localStorage Saat Ini:</p>
                        <p id="localStorageUsage" class="text-lg font-bold text-blue-700">Menghitung...</p>
                        <p class="text-xs text-slate-500 mt-2">Kapasitas total localStorage browser umumnya sekitar 5MB - 10MB per situs. Aplikasi ini tidak dapat mendeteksi sisa ruang secara akurat.</p>
                     </div>

                </div>
            </section>
        </main>
    </div>

    <div id="paymentModal" class="modal-backdrop hidden no-print">
        <div class="bg-white w-full max-w-md p-8 rounded-xl shadow-lg m-4 modal-content">
            <h2 class="text-2xl font-bold text-center mb-6">Pembayaran</h2>
            
            <div class="mb-4">
                <label for="customerSelectPayment" class="block text-sm font-medium text-slate-700 mb-1">Pelanggan (Opsional)</label>
                <select id="customerSelectPayment" class="w-full p-3 border rounded-lg bg-white">
                    <option value="">-- Pelanggan Umum --</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 mb-1">Tipe Pembayaran</label>
                <div class="flex gap-4">
                    <label class="flex-1">
                        <input type="radio" name="paymentType" value="lunas" class="sr-only peer" checked>
                        <div class="p-3 border rounded-lg text-center cursor-pointer peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">Lunas</div>
                    </label>
                    <label class="flex-1">
                        <input type="radio" name="paymentType" value="cicil" class="sr-only peer">
                        <div class="p-3 border rounded-lg text-center cursor-pointer peer-checked:bg-amber-500 peer-checked:text-white peer-checked:border-amber-500">Cicil/Kasbon</div>
                    </label>
                </div>
            </div>
            
            <div class="mb-4">
                <p class="text-lg text-slate-600">Total Tagihan</p>
                <p id="modalTotal" class="text-4xl font-bold text-blue-600">Rp 0</p>
            </div>
            <div class="mb-4">
                <label for="amountPaid" id="amountPaidLabel" class="block text-sm font-medium text-slate-700 mb-1">Uang Tunai</label>
                <input type="number" id="amountPaid" placeholder="Masukkan jumlah uang" class="w-full p-4 border-2 rounded-lg text-2xl focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div id="sisaTagihanSection" class="mb-4 hidden">
                <p class="text-sm text-slate-600">Sisa Akan Dicatat Sebagai Hutang</p>
                <p id="sisaTagihanValue" class="text-2xl font-bold text-red-600">Rp 0</p>
            </div>
            <div class="mb-6">
                <p class="text-lg text-slate-600">Kembalian</p>
                <p id="changeAmount" class="text-4xl font-bold text-emerald-600">Rp 0</p>
            </div>
            <div id="paymentActions" class="flex gap-4">
                <button id="closeModalBtn" class="w-full bg-slate-200 text-slate-800 p-3 rounded-lg font-bold hover:bg-slate-300 transition">Tutup</button>
                <button id="completeTransactionBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition disabled:bg-slate-300">Selesaikan Transaksi</button>
            </div>
            <div id="afterPaymentActions" class="hidden flex-col gap-3 mt-4">
                 <button id="printReceiptBtn" class="w-full bg-teal-500 text-white p-3 rounded-lg font-bold hover:bg-teal-600 transition">Cetak Struk</button>
                 <button id="newTransactionBtn" class="w-full bg-slate-200 text-slate-800 p-3 rounded-lg font-bold hover:bg-slate-300 transition">Transaksi Baru</button>
            </div>
        </div>
    </div>
    
    <div id="productModal" class="modal-backdrop hidden no-print">
        <div class="bg-white w-full max-w-lg p-8 rounded-xl shadow-lg m-4 modal-content">
            <h2 id="productModalTitle" class="text-2xl font-bold mb-6">Tambah Produk Baru</h2>
            <form id="productForm" class="space-y-4">
                <input type="hidden" id="productId">
                <div>
                    <label for="productName" class="block text-sm font-medium text-slate-700 mb-1">Nama Produk</label>
                    <input type="text" id="productName" class="w-full p-3 border rounded-lg" required>
                </div>
                <div>
                    <label for="productCategoryModal" class="block text-sm font-medium text-slate-700 mb-1">Kategori</label>
                    <select id="productCategoryModal" class="w-full p-3 border rounded-lg bg-white" required>
                    </select>
                </div>
                <div>
                    <label for="productBarcode" class="block text-sm font-medium text-slate-700 mb-1">Kode Barcode (Opsional)</label>
                    <div class="flex items-center gap-2">
                        <input type="text" id="productBarcode" class="w-full p-3 border rounded-lg">
                        <button type="button" id="scanBarcodeForProductBtn" class="bg-indigo-500 text-white px-4 py-3 rounded-lg font-semibold hover:bg-indigo-600 transition">üì∑</button>
                    </div>
                </div>
                <div>
                    <label for="productIcon" class="block text-sm font-medium text-slate-700 mb-1">Ikon Produk (Emoji/Simbol)</label>
                    <input type="text" id="productIcon" class="w-full p-3 border rounded-lg" maxlength="2">
                </div>
                 <div>
                    <label for="productCostPrice" class="block text-sm font-medium text-slate-700 mb-1">Harga Beli (Rp)</label>
                    <input type="number" id="productCostPrice" class="w-full p-3 border rounded-lg" required min="0">
                </div>
                 <div>
                    <label for="productPrice" class="block text-sm font-medium text-slate-700 mb-1">Harga Jual (Rp)</label>
                    <input type="number" id="productPrice" class="w-full p-3 border rounded-lg" required min="0">
                </div>
                 <div>
                    <label for="productStock" class="block text-sm font-medium text-slate-700 mb-1">Stok Awal</label>
                    <input type="number" id="productStock" class="w-full p-3 border rounded-lg" required min="0">
                </div>
                <div>
                    <label for="productDescription" class="block text-sm font-medium text-slate-700 mb-1">Deskripsi Produk</label>
                    <textarea id="productDescription" class="w-full p-3 border rounded-lg" rows="3"></textarea>
                    <button type="button" id="generateDescBtn" class="mt-2 text-sm bg-purple-100 text-purple-700 px-3 py-1.5 rounded-lg hover:bg-purple-200 transition">‚ú® Buat Deskripsi Otomatis</button>
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" id="closeProductModalBtn" class="w-full bg-slate-200 text-slate-800 p-3 rounded-lg font-bold hover:bg-slate-300 transition">Batal</button>
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition">Simpan Produk</button>
                </div>
            </form>
        </div>
    </div>

    <div id="categoryManagementModal" class="modal-backdrop hidden no-print">
        <div class="bg-white w-full max-w-xl p-8 rounded-xl shadow-lg m-4 modal-content">
            <h2 class="text-2xl font-bold mb-6">Kelola Kategori Produk</h2>
            
            <div class="mb-6 p-4 border rounded-lg bg-slate-50">
                <h3 class="text-lg font-semibold mb-3">Tambah Kategori Baru</h3>
                <form id="addCategoryForm" class="flex gap-3 items-end">
                    <div class="flex-1">
                        <label for="newCategoryName" class="block text-sm font-medium text-slate-700 mb-1">Nama Kategori Baru</label>
                        <input type="text" id="newCategoryName" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <button type="submit" class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition h-full">Tambah</button>
                </form>
            </div>

            <div class="mb-6 p-4 border rounded-lg bg-slate-50 hidden" id="editCategorySection">
                <h3 class="text-lg font-semibold mb-3">Edit Kategori: <span id="editingCategoryOriginalName" class="font-normal text-blue-600"></span></h3>
                <form id="editCategoryForm" class="flex gap-3 items-end">
                     <input type="hidden" id="originalCategoryNameToEdit">
                    <div class="flex-1">
                        <label for="editCategoryInputName" class="block text-sm font-medium text-slate-700 mb-1">Nama Kategori Baru</label>
                        <input type="text" id="editCategoryInputName" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <button type="submit" class="bg-blue-600 text-white px-5 py-3 rounded-lg font-semibold hover:bg-blue-700 transition h-full">Simpan</button>
                    <button type="button" id="cancelEditCategoryBtn" class="bg-slate-300 text-slate-800 px-5 py-3 rounded-lg font-semibold hover:bg-slate-400 transition h-full">Batal</button>
                </form>
            </div>
            
            <div>
                <h3 class="text-lg font-semibold mb-3">Daftar Kategori</h3>
                <ul id="categoryList" class="space-y-2 max-h-60 overflow-y-auto border rounded-lg p-3">
                    <li class="text-slate-500">Memuat kategori...</li>
                </ul>
            </div>

            <div class="mt-8 flex justify-end">
                <button type="button" id="closeCategoryManagementModalBtn" class="bg-slate-200 text-slate-800 px-6 py-3 rounded-lg font-bold hover:bg-slate-300 transition">Tutup</button>
            </div>
        </div>
    </div>

    <div id="customerModal" class="modal-backdrop hidden no-print">
        <div class="bg-white w-full max-w-lg p-8 rounded-xl shadow-lg m-4 modal-content">
            <h2 id="customerModalTitle" class="text-2xl font-bold mb-6">Tambah Pelanggan Baru</h2>
            <form id="customerForm" class="space-y-4">
                <input type="hidden" id="customerId">
                <div>
                    <label for="customerName" class="block text-sm font-medium text-slate-700 mb-1">Nama Pelanggan</label>
                    <input type="text" id="customerName" class="w-full p-3 border rounded-lg" required>
                </div>
                <div>
                    <label for="customerPhone" class="block text-sm font-medium text-slate-700 mb-1">No. Telepon</label>
                    <input type="tel" id="customerPhone" class="w-full p-3 border rounded-lg">
                </div>
                 <div>
                    <label for="customerAddress" class="block text-sm font-medium text-slate-700 mb-1">Alamat</label>
                    <textarea id="customerAddress" class="w-full p-3 border rounded-lg" rows="3"></textarea>
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" id="closeCustomerModalBtn" class="w-full bg-slate-200 text-slate-800 p-3 rounded-lg font-bold hover:bg-slate-300 transition">Batal</button>
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition">Simpan Pelanggan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="customTransactionModal" class="modal-backdrop hidden no-print">
        <div class="bg-white w-full max-w-lg p-8 rounded-xl shadow-lg m-4 modal-content">
            <h2 class="text-2xl font-bold mb-6">Tambah Transaksi Kustom</h2>
            <form id="customTransactionForm" class="space-y-4">
                <div>
                    <label for="customItemName" class="block text-sm font-medium text-slate-700 mb-1">Nama Barang/Jasa</label>
                    <input type="text" id="customItemName" class="w-full p-3 border rounded-lg" required placeholder="cth: Pulsa Telkomsel 10rb">
                </div>
                <div>
                    <label for="customItemPrice" class="block text-sm font-medium text-slate-700 mb-1">Harga Jual (Rp)</label>
                    <input type="number" id="customItemPrice" class="w-full p-3 border rounded-lg" required min="0">
                </div>
                <div>
                    <label for="customItemCost" class="block text-sm font-medium text-slate-700 mb-1">Harga Beli/Modal (Rp) (Opsional)</label>
                    <input type="number" id="customItemCost" class="w-full p-3 border rounded-lg" min="0" placeholder="Kosongkan jika tidak ada">
                </div>
                <div>
                    <label for="customItemQuantity" class="block text-sm font-medium text-slate-700 mb-1">Kuantitas</label>
                    <input type="number" id="customItemQuantity" value="1" class="w-full p-3 border rounded-lg" required min="1">
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" id="closeCustomTransactionModalBtn" class="w-full bg-slate-200 text-slate-800 p-3 rounded-lg font-bold hover:bg-slate-300 transition">Batal</button>
                    <button type="submit" class="w-full bg-sky-600 text-white p-3 rounded-lg font-bold hover:bg-sky-700 transition">Tambahkan ke Keranjang</button>
                </div>
            </form>
        </div>
    </div>

    <div id="debtPaymentModal" class="modal-backdrop hidden no-print">
        <div class="bg-white w-full max-w-md p-8 rounded-xl shadow-lg m-4 modal-content">
            <h2 class="text-2xl font-bold text-center mb-2">Pembayaran Hutang</h2>
            <p class="text-center text-slate-600 mb-6">Pelanggan: <span id="debtPaymentCustomerName" class="font-semibold"></span></p>
            
            <div class="mb-4">
                <p class="text-lg text-slate-600">Total Hutang Saat Ini</p>
                <p id="currentDebtAmount" class="text-3xl font-bold text-red-600">Rp 0</p>
            </div>
            <div class="mb-4">
                <label for="debtPaymentAmountInput" class="block text-sm font-medium text-slate-700 mb-1">Jumlah Pembayaran (Rp)</label>
                <input type="number" id="debtPaymentAmountInput" placeholder="Masukkan jumlah pembayaran" class="w-full p-4 border-2 rounded-lg text-xl focus:ring-2 focus:ring-green-500 outline-none">
            </div>
            <div class="flex gap-4 mt-8">
                <button id="closeDebtPaymentModalBtn" class="w-full bg-slate-200 text-slate-800 p-3 rounded-lg font-bold hover:bg-slate-300 transition">Batal</button>
                <button id="processDebtPaymentBtn" class="w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 transition">Proses Pembayaran</button>
            </div>
        </div>
    </div>

    <div id="barcodeScannerModal" class="modal-backdrop hidden no-print">
        <div class="bg-white w-full max-w-md p-6 rounded-xl shadow-lg m-4 modal-content">
            <h2 class="text-2xl font-bold text-center mb-4">Scan Barcode Produk</h2>
            <div id="barcodeScannerViewport" class="relative w-full h-64 bg-slate-200 rounded overflow-hidden mb-4">
                {/* QuaggaJS will attach camera feed here */}
            </div>
            <p id="barcodeScannerStatus" class="text-center text-slate-600 mb-4">Arahkan kamera ke barcode...</p>
            <button id="closeBarcodeScannerModalBtn" class="w-full bg-slate-200 text-slate-800 p-3 rounded-lg font-bold hover:bg-slate-300 transition">Tutup Scanner</button>
        </div>
    </div>

    <div id="printableReceipt" class="print-only">
        <div style="text-align: center; margin-bottom: 10px;">
            <h3 id="receiptShopName" style="margin:0; font-size: 14pt;">Nama Warung</h3>
            <p id="receiptShopAddress" style="margin:0; font-size: 9pt;">Alamat Warung</p>
            <p id="receiptShopPhone" style="margin:0; font-size: 9pt;">Telepon Warung</p>
        </div>
        <hr style="border-top: 1px dashed #000; margin-bottom: 5px;">
        <p style="font-size: 9pt; margin: 2px 0;">ID Transaksi: <span id="receiptTransactionId"></span></p>
        <p style="font-size: 9pt; margin: 2px 0;">Tanggal: <span id="receiptDateTime"></span></p>
        <p style="font-size: 9pt; margin: 2px 0;">Pelanggan: <span id="receiptCustomerName"></span></p>
        <hr style="border-top: 1px dashed #000; margin-top: 5px; margin-bottom: 5px;">
        <table>
            <thead>
                <tr>
                    <th style="font-size: 9pt;">Item</th>
                    <th style="font-size: 9pt; text-align:center;">Qty</th>
                    <th style="font-size: 9pt; text-align:right;">Harga</th>
                    <th style="font-size: 9pt; text-align:right;">Subtotal</th>
                </tr>
            </thead>
            <tbody id="receiptItemsTableBody">
                </tbody>
        </table>
        <hr style="border-top: 1px dashed #000; margin-top: 5px; margin-bottom: 5px;">
        <div style="font-size: 10pt;">
            <div style="display: flex; justify-content: space-between;"><span>Total Belanja:</span> <span id="receiptTotalAmount"></span></div>
            <div style="display: flex; justify-content: space-between;"><span>Jumlah Bayar:</span> <span id="receiptAmountPaid"></span></div>
            <div style="display: flex; justify-content: space-between;"><span>Kembalian:</span> <span id="receiptChangeAmount"></span></div>
            <div id="receiptSisaHutangRow" style="display: none; justify-content: space-between; color: red; font-weight: bold;"><span>Sisa Hutang:</span> <span id="receiptSisaHutang"></span></div>
        </div>
        <hr style="border-top: 1px dashed #000; margin-top: 5px; margin-bottom: 5px;">
        <p class="receipt-footer">Terima kasih telah berbelanja!</p>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // Core state variables declared first
    let mockProducts, productCategories, pelangganList, cart, dailyTransactions, appSettings, expensesList;
    let userProvidedGeminiApiKey = ''; 
    let lastTransactionForReceipt = null; 
    let barcodeScannerStream = null; 
    let barcodeScanTargetInputId = null; 
    let isQuaggaRunning = false; 

    const formatRupiah = (number) => {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
    };
    
    const LS_KEYS = {
        PRODUCTS: 'kasWarung_products',
        CATEGORIES: 'kasWarung_categories',
        CUSTOMERS: 'kasWarung_customers',
        TRANSACTIONS: 'kasWarung_transactions',
        SETTINGS: 'kasWarung_appSettings',
        GEMINI_API_KEY: 'kasWarung_geminiApiKey',
        EXPENSES: 'kasWarung_expenses' 
    };

    // Initialization function for core data
    function initializeCoreData() {
        const storedProducts = localStorage.getItem(LS_KEYS.PRODUCTS);
        mockProducts = storedProducts ? JSON.parse(storedProducts) : [
            { id: 1, name: 'Kopi Instan Sachet', category: 'Minuman', hargaBeli: 1000, price: 1500, stock: 100, image: '‚òï', deskripsi: 'Kopi instan praktis.', kodeBarcode: '1111111111111' },
            { id: 2, name: 'Teh Celup Kotak', category: 'Minuman', hargaBeli: 4000, price: 5500, stock: 150, image: 'üçµ', deskripsi: 'Teh celup berkualitas.', kodeBarcode: '2222222222222' },
            { id: 3, name: 'Air Mineral 600ml', category: 'Minuman', hargaBeli: 2000, price: 3000, stock: 80, image: 'üíß', deskripsi: 'Air mineral murni.', kodeBarcode: '3333333333333' },
            { id: 4, name: 'Keripik Singkong Pedas', category: 'Makanan Ringan', hargaBeli: 3500, price: 5000, stock: 50, image: 'ü•î', deskripsi: 'Keripik singkong pedas.', kodeBarcode: '4444444444444' },
            { id: 5, name: 'Biskuit Coklat Pack', category: 'Makanan Ringan', hargaBeli: 6000, price: 7500, stock: 60, image: 'üç™', deskripsi: 'Biskuit coklat tebal.', kodeBarcode: '5555555555555' }
        ];

        const storedCategories = localStorage.getItem(LS_KEYS.CATEGORIES);
        const defaultCategories = ["Minuman", "Makanan Ringan", "Sembako", "Bumbu Dapur", "Perlengkapan Mandi", "Obat Ringan", "Lainnya"];
        productCategories = storedCategories ? JSON.parse(storedCategories) : defaultCategories;
        
        const uniqueCategoriesFromProducts = [...new Set(mockProducts.map(p => p.category))];
        productCategories = [...new Set([...productCategories, ...uniqueCategoriesFromProducts])].filter(cat => cat && cat.trim() !== "").sort();


        const storedCustomers = localStorage.getItem(LS_KEYS.CUSTOMERS);
        pelangganList = storedCustomers ? JSON.parse(storedCustomers) : [
            { id: 1, nama: "Budi Santoso", telepon: "08123456789", alamat: "Jl. Mawar No. 1", saldoHutang: 0 },
            { id: 2, nama: "Siti Aminah", telepon: "08765432100", alamat: "Jl. Melati No. 2A", saldoHutang: 25000 }
        ];

        const storedTransactions = localStorage.getItem(LS_KEYS.TRANSACTIONS);
        dailyTransactions = storedTransactions ? JSON.parse(storedTransactions).map(t => ({...t, timestamp: new Date(t.timestamp)})) : [];
        
        const storedSettings = localStorage.getItem(LS_KEYS.SETTINGS);
        appSettings = storedSettings ? JSON.parse(storedSettings) : {
            shopName: "Warung Sejahtera",
            shopAddress: "Jl. Merdeka No. 17, Jakarta",
            shopPhone: "081234567890"
        };

        const storedGeminiApiKey = localStorage.getItem(LS_KEYS.GEMINI_API_KEY);
        if (storedGeminiApiKey) {
            userProvidedGeminiApiKey = storedGeminiApiKey;
            document.getElementById('geminiApiKeyInput').value = userProvidedGeminiApiKey;
        }

        const storedExpenses = localStorage.getItem(LS_KEYS.EXPENSES);
        expensesList = storedExpenses ? JSON.parse(storedExpenses).map(e => ({...e, date: new Date(e.date)})) : [];
        
        cart = []; 
    }
    
    initializeCoreData(); 

    function saveDataToLocalStorage() {
        localStorage.setItem(LS_KEYS.PRODUCTS, JSON.stringify(mockProducts));
        localStorage.setItem(LS_KEYS.CATEGORIES, JSON.stringify(productCategories));
        localStorage.setItem(LS_KEYS.CUSTOMERS, JSON.stringify(pelangganList));
        localStorage.setItem(LS_KEYS.TRANSACTIONS, JSON.stringify(dailyTransactions));
        localStorage.setItem(LS_KEYS.SETTINGS, JSON.stringify(appSettings));
        localStorage.setItem(LS_KEYS.EXPENSES, JSON.stringify(expensesList));
        updateLocalStorageUsageDisplay(); 
    }
    
    function saveGeminiApiKeyToLocalStorage(apiKey) {
        localStorage.setItem(LS_KEYS.GEMINI_API_KEY, apiKey);
        userProvidedGeminiApiKey = apiKey; 
    }


    function loadDataFromLocalStorage() { 
        document.getElementById('shopName').value = appSettings.shopName;
        document.getElementById('shopAddress').value = appSettings.shopAddress;
        document.getElementById('shopPhone').value = appSettings.shopPhone;
        document.getElementById('geminiApiKeyInput').value = userProvidedGeminiApiKey || "";


        if (localStorage.getItem(LS_KEYS.PRODUCTS) === null && 
            localStorage.getItem(LS_KEYS.CATEGORIES) === null &&
            localStorage.getItem(LS_KEYS.CUSTOMERS) === null &&
            localStorage.getItem(LS_KEYS.TRANSACTIONS) === null &&
            localStorage.getItem(LS_KEYS.SETTINGS) === null &&
            localStorage.getItem(LS_KEYS.GEMINI_API_KEY) === null &&
            localStorage.getItem(LS_KEYS.EXPENSES) === null
           ) {
            saveDataToLocalStorage(); 
        }
    }


    const navLinks = document.querySelectorAll('.nav-link');
    const pageContents = document.querySelectorAll('.page-content');
    const productListEl = document.getElementById('productList');
    const cartItemsEl = document.getElementById('cartItems');
    const cartTotalEl = document.getElementById('cartTotal');
    const payButton = document.getElementById('payButton');
    const paymentModal = document.getElementById('paymentModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const amountPaidInput = document.getElementById('amountPaid');
    const amountPaidLabel = document.getElementById('amountPaidLabel');
    const changeAmountEl = document.getElementById('changeAmount');
    const modalTotalEl = document.getElementById('modalTotal');
    const completeTransactionBtn = document.getElementById('completeTransactionBtn');
    const searchInput = document.getElementById('searchInput');
    const categoryFilterEl = document.getElementById('categoryFilter');
    const productTableBody = document.getElementById('productTableBody');
    const addProductBtn = document.getElementById('addProductBtn');
    const productModal = document.getElementById('productModal');
    const closeProductModalBtn = document.getElementById('closeProductModalBtn');
    const productForm = document.getElementById('productForm');
    const productModalTitle = document.getElementById('productModalTitle');
    const productCategoryModalEl = document.getElementById('productCategoryModal');
    const productDescriptionTextarea = document.getElementById('productDescription');
    const generateDescBtn = document.getElementById('generateDescBtn');
    const scanBarcodeForProductBtn = document.getElementById('scanBarcodeForProductBtn');

    const penjualanHariIniEl = document.getElementById('penjualanHariIniEl');
    const labaHariIniEl = document.getElementById('labaHariIniEl');
    const totalPiutangEl = document.getElementById('totalPiutangEl');
    const transaksiHariIniEl = document.getElementById('transaksiHariIniEl');
    const produkTerlarisEl = document.getElementById('produkTerlarisEl');
    const stokKritisListEl = document.getElementById('stokKritisList');
    const transaksiTerakhirListEl = document.getElementById('transaksiTerakhirList');
    const generatePromotionBtn = document.getElementById('generatePromotionBtn');
    const promotionIdeasContainer = document.getElementById('promotionIdeasContainer');
    const pengeluaranHariIniDashboardEl = document.getElementById('pengeluaranHariIniDashboardEl');
    
    const reportPeriodEl = document.getElementById('reportPeriod');
    const reportDateEl = document.getElementById('reportDate');
    const reportDetailsTableContainerEl = document.getElementById('reportDetailsTableContainer');
    const piutangTableBodyEl = document.getElementById('piutangTableBody');
    const settingsForm = document.getElementById('settingsForm');
    const settingsMessage = document.getElementById('settingsMessage');

    const manageCategoriesBtn = document.getElementById('manageCategoriesBtn');
    const categoryManagementModal = document.getElementById('categoryManagementModal');
    const closeCategoryManagementModalBtn = document.getElementById('closeCategoryManagementModalBtn');
    const addCategoryForm = document.getElementById('addCategoryForm');
    const newCategoryNameInput = document.getElementById('newCategoryName');
    const categoryListEl = document.getElementById('categoryList');
    const editCategorySection = document.getElementById('editCategorySection');
    const editingCategoryOriginalNameEl = document.getElementById('editingCategoryOriginalName');
    const originalCategoryNameToEditInput = document.getElementById('originalCategoryNameToEdit');
    const editCategoryInputName = document.getElementById('editCategoryInputName');
    const editCategoryForm = document.getElementById('editCategoryForm');
    const cancelEditCategoryBtn = document.getElementById('cancelEditCategoryBtn');

    const addCustomerBtn = document.getElementById('addCustomerBtn');
    const customerModal = document.getElementById('customerModal');
    const customerModalTitle = document.getElementById('customerModalTitle');
    const customerForm = document.getElementById('customerForm');
    const closeCustomerModalBtn = document.getElementById('closeCustomerModalBtn');
    const customerTableBody = document.getElementById('customerTableBody');
    const customerSelectPaymentEl = document.getElementById('customerSelectPayment');
    const paymentTypeRadios = document.querySelectorAll('input[name="paymentType"]');
    const sisaTagihanSection = document.getElementById('sisaTagihanSection');
    const sisaTagihanValueEl = document.getElementById('sisaTagihanValue');

    const backupDataBtn = document.getElementById('backupDataBtn');
    const restoreFileInput = document.getElementById('restoreFile');
    const localStorageUsageEl = document.getElementById('localStorageUsage');
    const geminiApiKeyInput = document.getElementById('geminiApiKeyInput');
    const saveGeminiApiKeyBtn = document.getElementById('saveGeminiApiKeyBtn');

    const addCustomTransactionBtn = document.getElementById('addCustomTransactionBtn');
    const customTransactionModal = document.getElementById('customTransactionModal');
    const closeCustomTransactionModalBtn = document.getElementById('closeCustomTransactionModalBtn');
    const customTransactionForm = document.getElementById('customTransactionForm');

    const debtPaymentModal = document.getElementById('debtPaymentModal');
    const debtPaymentCustomerNameEl = document.getElementById('debtPaymentCustomerName');
    const currentDebtAmountEl = document.getElementById('currentDebtAmount');
    const debtPaymentAmountInput = document.getElementById('debtPaymentAmountInput');
    const closeDebtPaymentModalBtn = document.getElementById('closeDebtPaymentModalBtn');
    const processDebtPaymentBtn = document.getElementById('processDebtPaymentBtn');
    let currentPayingCustomerId = null;

    const paymentActionsDiv = document.getElementById('paymentActions');
    const afterPaymentActionsDiv = document.getElementById('afterPaymentActions');
    const printReceiptBtn = document.getElementById('printReceiptBtn');
    const newTransactionBtn = document.getElementById('newTransactionBtn');

    const scanBarcodeBtn = document.getElementById('scanBarcodeBtn');
    const barcodeScannerModal = document.getElementById('barcodeScannerModal');
    const barcodeScannerViewport = document.getElementById('barcodeScannerViewport');
    const barcodeScannerStatusEl = document.getElementById('barcodeScannerStatus');
    const closeBarcodeScannerModalBtn = document.getElementById('closeBarcodeScannerModalBtn');
    const exportReportBtn = document.getElementById('exportReportBtn');

    const addExpenseForm = document.getElementById('addExpenseForm');
    const expenseListTableBodyEl = document.getElementById('expenseListTableBody');
    const financeTotalRevenueEl = document.getElementById('financeTotalRevenue');
    const financeTotalExpensesEl = document.getElementById('financeTotalExpenses');
    const financeNetProfitEl = document.getElementById('financeNetProfit');


    if (addCustomTransactionBtn) {
        addCustomTransactionBtn.addEventListener('click', () => {
            customTransactionForm.reset();
            customTransactionModal.classList.remove('hidden');
        });
    }
    if (closeCustomTransactionModalBtn) {
        closeCustomTransactionModalBtn.addEventListener('click', () => {
            customTransactionModal.classList.add('hidden');
        });
    }
    if (customTransactionForm) {
        customTransactionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const itemName = document.getElementById('customItemName').value.trim();
            const itemPrice = parseFloat(document.getElementById('customItemPrice').value);
            const itemCost = parseFloat(document.getElementById('customItemCost').value) || 0; 
            const itemQuantity = parseInt(document.getElementById('customItemQuantity').value) || 1;

            if (!itemName || isNaN(itemPrice) || itemPrice <= 0 || isNaN(itemQuantity) || itemQuantity <=0) {
                showCustomAlert("Nama barang, harga jual, dan kuantitas harus valid.", "Error");
                return;
            }
            if (itemCost > itemPrice) {
                 showCustomAlert("Harga beli/modal tidak boleh lebih besar dari harga jual.", "Error");
                return;
            }

            const customItem = {
                id: `custom-${Date.now()}`, 
                name: itemName,
                price: itemPrice,
                hargaBeli: itemCost,
                quantity: itemQuantity,
                isCustom: true, 
                category: 'Kustom' 
            };
            
            const existingCartItem = cart.find(item => item.id === customItem.id); 
            if (existingCartItem) {
                existingCartItem.quantity += customItem.quantity;
            } else {
                cart.push(customItem);
            }
            
            renderCart();
            customTransactionModal.classList.add('hidden');
        });
    }


    if (saveGeminiApiKeyBtn) {
        saveGeminiApiKeyBtn.addEventListener('click', () => {
            const newApiKey = geminiApiKeyInput.value.trim();
            if (newApiKey) {
                saveGeminiApiKeyToLocalStorage(newApiKey);
                showCustomAlert('API Key Gemini berhasil disimpan di localStorage.', 'Sukses');
            } else {
                localStorage.removeItem(LS_KEYS.GEMINI_API_KEY); 
                userProvidedGeminiApiKey = '';
                showCustomAlert('API Key Gemini dihapus dari localStorage.', 'Info');
            }
        });
    }


    function calculateLocalStorageUsage() {
        let totalBytes = 0;
        for (const key in LS_KEYS) {
            const item = localStorage.getItem(LS_KEYS[key]);
            if (item) {
                totalBytes += item.length * 2; 
            }
        }
        return totalBytes;
    }

    function updateLocalStorageUsageDisplay() {
        if (localStorageUsageEl) {
            const usageBytes = calculateLocalStorageUsage();
            const usageKB = (usageBytes / 1024).toFixed(2);
            localStorageUsageEl.textContent = `${usageKB} KB`;
        }
    }


    function refreshAllUI() {
        populateCategories();
        populateCustomerDropdown();
        renderProducts(searchInput.value, categoryFilterEl.value);
        renderCart();
        renderProductTable();
        renderCustomerTable();
        updateDashboard();
        updateSalesReport();
        updatePiutangReport();
        renderExpenseList();
        updateFinancialSummary();
        
        document.getElementById('shopName').value = appSettings.shopName;
        document.getElementById('shopAddress').value = appSettings.shopAddress;
        document.getElementById('shopPhone').value = appSettings.shopPhone;
        geminiApiKeyInput.value = userProvidedGeminiApiKey || "";
        updateLocalStorageUsageDisplay();
    }
    
    backupDataBtn.addEventListener('click', () => {
        const backup = {
            products: mockProducts,
            categories: productCategories,
            customers: pelangganList,
            transactions: dailyTransactions,
            settings: appSettings,
            geminiApiKey: userProvidedGeminiApiKey,
            expenses: expensesList 
        };
        const jsonString = JSON.stringify(backup, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `kas_warung_backup_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showCustomAlert('Data berhasil di-backup! File JSON telah diunduh.', 'Sukses');
    });

    restoreFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            showCustomConfirm("Restoring data akan menggantikan semua data saat ini. Lanjutkan?", () => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const restoredData = JSON.parse(e.target.result);
                        if (restoredData.products && restoredData.categories && restoredData.customers && restoredData.transactions && restoredData.settings) {
                            mockProducts = restoredData.products;
                            productCategories = restoredData.categories;
                            pelangganList = restoredData.customers;
                            dailyTransactions = restoredData.transactions.map(t => ({...t, timestamp: new Date(t.timestamp)})); 
                            appSettings = restoredData.settings;
                            expensesList = restoredData.expenses ? restoredData.expenses.map(ex => ({...ex, date: new Date(ex.date)})) : [];
                            
                            if (restoredData.geminiApiKey) {
                                saveGeminiApiKeyToLocalStorage(restoredData.geminiApiKey);
                            } else { 
                                localStorage.removeItem(LS_KEYS.GEMINI_API_KEY);
                                userProvidedGeminiApiKey = '';
                            }

                            saveDataToLocalStorage(); 
                            refreshAllUI(); 
                            showCustomAlert('Data berhasil di-restore!', 'Sukses');
                        } else {
                            showCustomAlert('Format file backup tidak valid atau data tidak lengkap.', 'Error');
                        }
                    } catch (error) {
                        showCustomAlert('Gagal membaca file backup. Pastikan file valid dan tidak rusak.', 'Error');
                    }
                };
                reader.readAsText(file);
                event.target.value = null; 
            }, "Konfirmasi Restore Data");
        }
    });


    const populateCategories = () => {
        const uniqueCategories = [...new Set(mockProducts.map(p => p.category).concat(productCategories))].sort();
        productCategories = uniqueCategories.filter(cat => cat && cat.trim() !== ""); 

        categoryFilterEl.innerHTML = '<option value="all">Semua Kategori</option>';
        productCategoryModalEl.innerHTML = ''; 

        if (productCategories.length === 0) {
             const defaultOption = document.createElement('option');
             defaultOption.value = "";
             defaultOption.textContent = "Tidak ada kategori";
             defaultOption.disabled = true;
             productCategoryModalEl.appendChild(defaultOption);
        } else {
            productCategories.forEach(cat => {
                const optionFilter = document.createElement('option');
                optionFilter.value = cat;
                optionFilter.textContent = cat;
                categoryFilterEl.appendChild(optionFilter);

                const optionModal = document.createElement('option');
                optionModal.value = cat;
                optionModal.textContent = cat;
                productCategoryModalEl.appendChild(optionModal);
            });
        }
        renderCategoryListForManagement();
    };

    const renderCategoryListForManagement = () => {
        categoryListEl.innerHTML = '';
        if (productCategories.length === 0) {
            categoryListEl.innerHTML = '<li class="text-slate-500 p-2">Belum ada kategori. Tambahkan kategori baru di atas.</li>';
            return;
        }
        productCategories.forEach(cat => {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center p-2 border-b last:border-b-0 hover:bg-slate-100';
            li.innerHTML = `
                <span class="category-name-text flex-1 break-all">${cat}</span>
                <div class="flex gap-2 ml-2">
                    <button class="edit-category-list-btn text-blue-600 hover:underline text-sm" data-category="${cat}">Edit</button>
                    <button class="delete-category-list-btn text-red-600 hover:underline text-sm" data-category="${cat}">Hapus</button>
                </div>
            `;
            categoryListEl.appendChild(li);
        });

        document.querySelectorAll('.edit-category-list-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const categoryToEdit = e.target.dataset.category;
                editingCategoryOriginalNameEl.textContent = categoryToEdit;
                originalCategoryNameToEditInput.value = categoryToEdit;
                editCategoryInputName.value = categoryToEdit;
                editCategorySection.classList.remove('hidden');
                addCategoryForm.parentElement.classList.add('hidden'); 
                editCategoryInputName.focus();
            });
        });
        
        document.querySelectorAll('.delete-category-list-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const categoryToDelete = e.target.dataset.category;
                handleDeleteCategory(categoryToDelete);
            });
        });
    };
    
    const handleDeleteCategory = (categoryName) => {
        const isCategoryInUse = mockProducts.some(p => p.category === categoryName);
        if (isCategoryInUse) {
            showCustomAlert(`Kategori "${categoryName}" tidak dapat dihapus karena masih digunakan oleh beberapa produk. Ubah kategori produk tersebut terlebih dahulu.`, "Peringatan");
            return;
        }

        showCustomConfirm(`Apakah Anda yakin ingin menghapus kategori "${categoryName}"? Tindakan ini tidak dapat diurungkan.`, () => {
            productCategories = productCategories.filter(cat => cat !== categoryName);
            saveDataToLocalStorage();
            populateCategories();
            updateSalesReport(); 
            showCustomAlert(`Kategori "${categoryName}" berhasil dihapus.`, "Sukses");
        });
    };
    
    manageCategoriesBtn.addEventListener('click', () => {
        renderCategoryListForManagement();
        editCategorySection.classList.add('hidden'); 
        addCategoryForm.parentElement.classList.remove('hidden');
        newCategoryNameInput.value = '';
        categoryManagementModal.classList.remove('hidden');
    });

    closeCategoryManagementModalBtn.addEventListener('click', () => {
        categoryManagementModal.classList.add('hidden');
    });

    addCategoryForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const newCategory = newCategoryNameInput.value.trim();
        if (newCategory) {
            if (productCategories.map(c => c.toLowerCase()).includes(newCategory.toLowerCase())) {
                showCustomAlert(`Kategori "${newCategory}" sudah ada.`, "Peringatan");
            } else {
                productCategories.push(newCategory);
                productCategories.sort();
                saveDataToLocalStorage();
                populateCategories(); 
                newCategoryNameInput.value = '';
                showCustomAlert(`Kategori "${newCategory}" berhasil ditambahkan.`, "Sukses");
            }
        }
    });

    editCategoryForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const originalName = originalCategoryNameToEditInput.value;
        const newName = editCategoryInputName.value.trim();

        if (!newName) {
            showCustomAlert("Nama kategori tidak boleh kosong.", "Error");
            return;
        }

        if (newName.toLowerCase() === originalName.toLowerCase()) {
            editCategorySection.classList.add('hidden');
            addCategoryForm.parentElement.classList.remove('hidden');
            return;
        }

        if (productCategories.map(c => c.toLowerCase()).includes(newName.toLowerCase())) {
            showCustomAlert(`Kategori "${newName}" sudah ada. Pilih nama lain.`, "Peringatan");
            return;
        }

        const index = productCategories.findIndex(c => c.toLowerCase() === originalName.toLowerCase());
        if (index > -1) {
            productCategories[index] = newName;
            productCategories.sort();
        }

        mockProducts.forEach(p => {
            if (p.category.toLowerCase() === originalName.toLowerCase()) {
                p.category = newName;
            }
        });
        
        saveDataToLocalStorage();
        populateCategories(); 
        renderProductTable(); 
        renderProducts();     
        updateSalesReport();  

        editCategorySection.classList.add('hidden');
        addCategoryForm.parentElement.classList.remove('hidden');
        showCustomAlert(`Kategori "${originalName}" berhasil diubah menjadi "${newName}".`, "Sukses");
    });

    cancelEditCategoryBtn.addEventListener('click', () => {
        editCategorySection.classList.add('hidden');
        addCategoryForm.parentElement.classList.remove('hidden');
    });

    const renderProducts = (filter = '', category = 'all') => {
        productListEl.innerHTML = '';
        const filteredProducts = mockProducts.filter(p => {
            const nameMatch = p.name.toLowerCase().includes(filter.toLowerCase());
            const categoryMatch = category === 'all' || p.category === category;
            return nameMatch && categoryMatch && p.stock > 0;
        });

        if(filteredProducts.length === 0) {
            productListEl.innerHTML = '<p class="text-slate-400 col-span-full text-center py-10">Produk tidak ditemukan atau stok habis.</p>';
            return;
        }

        filteredProducts.forEach(product => {
            const productCard = document.createElement('div');
            productCard.className = 'bg-slate-50 border rounded-lg p-3 flex flex-col items-center text-center cursor-pointer hover:shadow-lg hover:border-blue-500 transition-all';
            productCard.innerHTML = `
                <div class="text-4xl mb-2 h-10 flex items-center justify-center">${product.image}</div>
                <h4 class="font-semibold text-sm h-10 flex items-center justify-center leading-tight">${product.name}</h4>
                <p class="text-blue-600 font-bold mt-1">${formatRupiah(product.price)}</p>
                <p class="text-xs text-slate-500">Stok: ${product.stock}</p>
            `;
            productCard.addEventListener('click', () => addToCart(product.id));
            productListEl.appendChild(productCard);
        });
    };
    
    const renderProductTable = () => {
        productTableBody.innerHTML = '';
        if (mockProducts.length === 0) {
            productTableBody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-slate-500">Belum ada produk.</td></tr>';
            return;
        }
        mockProducts.forEach(p => {
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-slate-50 transition-colors';
            row.innerHTML = `
                <td class="p-4">${p.name}</td>
                <td class="p-4">${p.category}</td>
                <td class="p-4">${p.kodeBarcode || '-'}</td>
                <td class="p-4">${formatRupiah(p.hargaBeli)}</td>
                <td class="p-4">${formatRupiah(p.price)}</td>
                <td class="p-4 ${p.stock <= 5 ? 'text-red-600 font-semibold' : (p.stock <=15 ? 'text-amber-600 font-medium' : '')}">${p.stock}</td>
                <td class="p-4">
                    <button class="text-blue-600 hover:underline mr-2 text-sm" data-id="${p.id}" onclick="window.app.editProduct(event)">Edit</button>
                    <button class="text-red-600 hover:underline text-sm" data-id="${p.id}" onclick="window.app.deleteProduct(event)">Hapus</button>
                </td>
            `;
            productTableBody.appendChild(row);
        });
    };

    const renderCustomerTable = () => {
        customerTableBody.innerHTML = '';
        if (pelangganList.length === 0) {
            customerTableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-slate-500">Belum ada pelanggan.</td></tr>';
            return;
        }
        pelangganList.forEach(c => {
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-slate-50 transition-colors';
            let actionButtons = `<button class="text-blue-600 hover:underline mr-2 text-sm" data-id="${c.id}" onclick="window.app.editCustomer(event)">Edit</button>
                                 <button class="text-red-600 hover:underline text-sm ml-2" data-id="${c.id}" onclick="window.app.deleteCustomer(event)">Hapus</button>`;
            if (c.saldoHutang > 0) {
                actionButtons += `<button class="text-green-600 hover:underline text-sm ml-2" data-id="${c.id}" onclick="window.app.openDebtPaymentModal(event)">Bayar Hutang</button>`;
            }

            row.innerHTML = `
                <td class="p-4">${c.nama}</td>
                <td class="p-4">${c.telepon || '-'}</td>
                <td class="p-4">${c.alamat || '-'}</td>
                <td class="p-4 text-right ${c.saldoHutang > 0 ? 'text-red-600 font-semibold' : ''}">${formatRupiah(c.saldoHutang)}</td>
                <td class="p-4">${actionButtons}</td>
            `;
            customerTableBody.appendChild(row);
        });
    };
    
    const populateCustomerDropdown = () => {
        customerSelectPaymentEl.innerHTML = '<option value="">-- Pelanggan Umum --</option>';
        pelangganList.forEach(c => {
            const option = document.createElement('option');
            option.value = c.id;
            option.textContent = c.nama;
            customerSelectPaymentEl.appendChild(option);
        });
    };

    addCustomerBtn.addEventListener('click', () => {
        customerModalTitle.innerText = 'Tambah Pelanggan Baru';
        customerForm.reset();
        document.getElementById('customerId').value = '';
        customerModal.classList.remove('hidden');
    });

    closeCustomerModalBtn.addEventListener('click', () => {
        customerModal.classList.add('hidden');
    });

    customerForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('customerId').value;
        const customerData = {
            nama: document.getElementById('customerName').value.trim(),
            telepon: document.getElementById('customerPhone').value.trim(),
            alamat: document.getElementById('customerAddress').value.trim(),
        };

        if (!customerData.nama) {
            showCustomAlert("Nama pelanggan tidak boleh kosong.", "Error");
            return;
        }

        if (id) { // Edit
            const index = pelangganList.findIndex(c => c.id === parseInt(id));
            if (index > -1) {
                pelangganList[index] = { ...pelangganList[index], ...customerData };
            }
        } else { // Add
            customerData.id = Date.now();
            customerData.saldoHutang = 0;
            pelangganList.unshift(customerData);
        }
        saveDataToLocalStorage();
        customerModal.classList.add('hidden');
        renderCustomerTable();
        populateCustomerDropdown();
        updatePiutangReport();
    });

    window.app = {
        updateQuantity: (itemId, change) => { 
            const cartItem = cart.find(item => String(item.id) === String(itemId)); 
            
            if (cartItem) {
                const newQuantity = cartItem.quantity + change;
                if (newQuantity <= 0) {
                    cart = cart.filter(item => String(item.id) !== String(itemId));
                } else {
                    if (cartItem.isCustom) { 
                        cartItem.quantity = newQuantity;
                    } else { 
                        const productInStock = mockProducts.find(p => p.id === cartItem.id);
                        if (productInStock && newQuantity > productInStock.stock) {
                            displayTemporaryMessage(cartItemsEl, "Stok produk tidak mencukupi.", "text-red-500");
                            cartItem.quantity = productInStock.stock; 
                        } else {
                            cartItem.quantity = newQuantity;
                        }
                    }
                }
            }
            renderCart();
        },
        editProduct: (event) => {
            const productId = parseInt(event.target.dataset.id);
            const product = mockProducts.find(p => p.id === productId);
            if(product){
                productModalTitle.innerText = "Edit Produk";
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.name;
                document.getElementById('productCategoryModal').value = product.category;
                document.getElementById('productBarcode').value = product.kodeBarcode || '';
                document.getElementById('productCostPrice').value = product.hargaBeli;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productStock').value = product.stock;
                productDescriptionTextarea.value = product.deskripsi || '';
                document.getElementById('productIcon').value = product.image || 'üÜï';
                productModal.classList.remove('hidden');
            }
        },
        deleteProduct: (event) => {
            const productId = parseInt(event.target.dataset.id);
            showCustomConfirm(`Apakah Anda yakin ingin menghapus produk ini? Produk yang ada di keranjang akan ikut terhapus.`, () => {
                cart = cart.filter(item => item.id !== productId);
                renderCart();

                const index = mockProducts.findIndex(p => p.id === productId);
                if(index > -1){
                    mockProducts.splice(index, 1);
                    saveDataToLocalStorage();
                    renderProductTable();
                    renderProducts();
                    updateDashboard(); 
                    populateCategories(); 
                }
            });
        },
        editCustomer: (event) => {
            const customerId = parseInt(event.target.dataset.id);
            const customer = pelangganList.find(c => c.id === customerId);
            if (customer) {
                customerModalTitle.innerText = "Edit Data Pelanggan";
                document.getElementById('customerId').value = customer.id;
                document.getElementById('customerName').value = customer.nama;
                document.getElementById('customerPhone').value = customer.telepon;
                document.getElementById('customerAddress').value = customer.alamat;
                customerModal.classList.remove('hidden');
            }
        },
        deleteCustomer: (event) => {
            const customerId = parseInt(event.target.dataset.id);
            const customer = pelangganList.find(c => c.id === customerId);
            if (!customer) {
                showCustomAlert("Pelanggan tidak ditemukan.", "Error");
                return;
            }

            if (customer.saldoHutang > 0) {
                showCustomAlert(`Pelanggan "${customer.nama}" tidak dapat dihapus karena masih memiliki saldo hutang sebesar ${formatRupiah(customer.saldoHutang)}. Harap lunasi hutang terlebih dahulu.`, "Peringatan");
                return;
            }
            
            showCustomConfirm(`Apakah Anda yakin ingin menghapus pelanggan "${customer.nama}"? Tindakan ini tidak dapat diurungkan.`, () => {
                pelangganList = pelangganList.filter(c => c.id !== customerId);
                saveDataToLocalStorage();
                renderCustomerTable();
                populateCustomerDropdown(); 
                updateDashboard(); 
                updatePiutangReport();
                showCustomAlert(`Pelanggan "${customer.nama}" berhasil dihapus.`, "Sukses");
            });
        },
        openDebtPaymentModal: (event) => {
            const customerId = parseInt(event.target.dataset.id);
            const customer = pelangganList.find(c => c.id === customerId);
            if (customer && customer.saldoHutang > 0) {
                currentPayingCustomerId = customerId;
                debtPaymentCustomerNameEl.textContent = customer.nama;
                currentDebtAmountEl.textContent = formatRupiah(customer.saldoHutang);
                debtPaymentAmountInput.value = '';
                debtPaymentAmountInput.max = customer.saldoHutang; 
                debtPaymentModal.classList.remove('hidden');
                debtPaymentAmountInput.focus();
            } else {
                showCustomAlert("Pelanggan tidak memiliki hutang atau tidak ditemukan.", "Info");
            }
        }
    };

    if (closeDebtPaymentModalBtn) {
        closeDebtPaymentModalBtn.addEventListener('click', () => {
            debtPaymentModal.classList.add('hidden');
            currentPayingCustomerId = null;
        });
    }

    if (processDebtPaymentBtn) {
        processDebtPaymentBtn.addEventListener('click', () => {
            const paymentAmount = parseFloat(debtPaymentAmountInput.value);
            const customer = pelangganList.find(c => c.id === currentPayingCustomerId);

            if (!customer) {
                showCustomAlert("Pelanggan tidak ditemukan.", "Error");
                return;
            }
            if (isNaN(paymentAmount) || paymentAmount <= 0) {
                showCustomAlert("Jumlah pembayaran tidak valid.", "Error");
                return;
            }
            if (paymentAmount > customer.saldoHutang) {
                showCustomAlert("Jumlah pembayaran melebihi total hutang.", "Error");
                return;
            }

            customer.saldoHutang -= paymentAmount;
            
            dailyTransactions.push({
                id: `DEBT-PMT/${new Date().toISOString().slice(0,10).replace(/-/g,'')}/${Date.now().toString().slice(-5)}`,
                items: [], 
                totalAmount: paymentAmount, 
                profit: 0, 
                timestamp: new Date(),
                pelangganId: customer.id,
                tipePembayaran: 'PEMBAYARAN_HUTANG',
                jumlahBayar: paymentAmount,
                sisaBayar: 0, 
                deskripsi: `Pembayaran hutang oleh ${customer.nama}`
            });
            
            saveDataToLocalStorage();
            renderCustomerTable();
            updateDashboard();
            updatePiutangReport();
            updateSalesReport(); 
            debtPaymentModal.classList.add('hidden');
            showCustomAlert(`Pembayaran hutang sebesar ${formatRupiah(paymentAmount)} untuk ${customer.nama} berhasil diproses.`, "Sukses");
            currentPayingCustomerId = null;
        });
    }


    const addToCart = (productId) => {
        const product = mockProducts.find(p => p.id === productId);
        if (!product || product.stock <= 0) {
            return;
        }
        const cartItem = cart.find(item => item.id === productId);

        if (cartItem) {
            if (cartItem.quantity < product.stock) {
                 cartItem.quantity++;
            } else {
                displayTemporaryMessage(cartItemsEl, "Stok produk tidak mencukupi di keranjang.", "text-red-500");
            }
        } else {
            cart.push({ ...product, quantity: 1 });
        }
        renderCart();
    };
    
    const renderCart = () => {
        cartItemsEl.innerHTML = '';
        if (cart.length === 0) {
            cartItemsEl.innerHTML = '<p class="text-slate-400 text-center">Keranjang masih kosong.</p>';
            payButton.disabled = true;
        } else {
            cart.forEach(item => {
                const cartItemEl = document.createElement('div');
                cartItemEl.className = 'flex items-center justify-between py-2 border-b border-slate-100 last:border-b-0';
                cartItemEl.innerHTML = `
                    <div class="flex-1 mr-2">
                        <p class="font-semibold text-sm">${item.name} ${item.isCustom ? '<span class="text-xs text-sky-600">(Kustom)</span>' : ''}</p>
                        <p class="text-xs text-slate-500">${formatRupiah(item.price)} x ${item.quantity}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="w-7 h-7 bg-slate-200 rounded-md font-bold hover:bg-slate-300 transition-colors" onclick="window.app.updateQuantity(${typeof item.id === 'string' && item.id.startsWith('custom-') ? `'${item.id}'` : item.id}, -1)">-</button>
                        <span class="w-5 text-center">${item.quantity}</span>
                        <button class="w-7 h-7 bg-slate-200 rounded-md font-bold hover:bg-slate-300 transition-colors" onclick="window.app.updateQuantity(${typeof item.id === 'string' && item.id.startsWith('custom-') ? `'${item.id}'` : item.id}, 1)">+</button>
                    </div>
                `;
                cartItemsEl.appendChild(cartItemEl);
            });
            payButton.disabled = false;
        }
        updateCartTotal();
    };
    
    const updateCartTotal = () => {
        const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        cartTotalEl.innerText = formatRupiah(total);
        return total;
    };

    payButton.addEventListener('click', () => {
        if (cart.length === 0) return;
        const total = updateCartTotal();
        modalTotalEl.innerText = formatRupiah(total);
        amountPaidInput.value = ''; 
        changeAmountEl.innerText = formatRupiah(0);
        sisaTagihanValueEl.innerText = formatRupiah(0);
        sisaTagihanSection.classList.add('hidden');
        amountPaidLabel.innerText = "Uang Tunai";
        document.querySelector('input[name="paymentType"][value="lunas"]').checked = true; 
        
        paymentActionsDiv.classList.remove('hidden');
        paymentActionsDiv.classList.add('flex');
        afterPaymentActionsDiv.classList.add('hidden');
        afterPaymentActionsDiv.classList.remove('flex', 'flex-col');
        completeTransactionBtn.disabled = true; 
        
        paymentModal.classList.remove('hidden');
        amountPaidInput.focus();
        updatePaymentModalUI(); 
    });

    closeModalBtn.addEventListener('click', () => {
        paymentModal.classList.add('hidden');
        paymentActionsDiv.classList.remove('hidden');
        paymentActionsDiv.classList.add('flex');
        afterPaymentActionsDiv.classList.add('hidden');
        afterPaymentActionsDiv.classList.remove('flex', 'flex-col');
    });
    
    paymentTypeRadios.forEach(radio => {
        radio.addEventListener('click', updatePaymentModalUI);
    });
    
    function updatePaymentModalUI() {
        const selectedPaymentType = document.querySelector('input[name="paymentType"]:checked').value;
        const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const paid = parseFloat(amountPaidInput.value) || 0;

        if (selectedPaymentType === 'cicil') {
            amountPaidLabel.innerText = "Jumlah Dibayar (Cicil)";
            sisaTagihanSection.classList.remove('hidden');
            const sisaTagihan = total - paid;
            sisaTagihanValueEl.innerText = formatRupiah(sisaTagihan > 0 ? sisaTagihan : 0);
            changeAmountEl.innerText = formatRupiah(0); 
            completeTransactionBtn.disabled = false; 
        } else { // Lunas
            amountPaidLabel.innerText = "Uang Tunai";
            sisaTagihanSection.classList.add('hidden');
            const change = paid - total;
            changeAmountEl.innerText = formatRupiah(change >= 0 ? change : 0);
            completeTransactionBtn.disabled = paid < total;
        }
    }

    amountPaidInput.addEventListener('input', updatePaymentModalUI);

    completeTransactionBtn.addEventListener('click', () => {
        if (cart.length === 0) return;
        
        const selectedCustomerId = customerSelectPaymentEl.value;
        const paymentType = document.querySelector('input[name="paymentType"]:checked').value;
        const totalAmount = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const amountPaid = parseFloat(amountPaidInput.value) || 0;

        if (paymentType === 'cicil' && !selectedCustomerId) {
            showCustomAlert("Silakan pilih pelanggan untuk transaksi cicilan/kasbon.", "Peringatan");
            return;
        }
        
        let currentTransactionProfit = 0;
        cart.forEach(cartItem => {
            if (cartItem.isCustom) { 
                 currentTransactionProfit += (cartItem.price - cartItem.hargaBeli) * cartItem.quantity;
            } else { 
                const product = mockProducts.find(p => p.id === cartItem.id);
                if(product) {
                    product.stock -= cartItem.quantity;
                    currentTransactionProfit += (product.price - product.hargaBeli) * cartItem.quantity;
                }
            }
        });
        
        const sisaBayar = paymentType === 'cicil' ? Math.max(0, totalAmount - amountPaid) : 0;
        const newTransactionId = `INV/${new Date().toISOString().slice(0,10).replace(/-/g,'')}/${Date.now().toString().slice(-5)}`;

        lastTransactionForReceipt = {
            id: newTransactionId,
            items: JSON.parse(JSON.stringify(cart)), 
            totalAmount: totalAmount,
            profit: currentTransactionProfit,
            timestamp: new Date(),
            pelangganId: selectedCustomerId || null,
            tipePembayaran: paymentType,
            jumlahBayar: amountPaid,
            sisaBayar: sisaBayar,
            kembalian: paymentType === 'lunas' ? Math.max(0, amountPaid - totalAmount) : 0
        };
        
        dailyTransactions.push(lastTransactionForReceipt);


        if (paymentType === 'cicil' && selectedCustomerId && sisaBayar > 0) {
            const customer = pelangganList.find(c => c.id === parseInt(selectedCustomerId));
            if (customer) {
                customer.saldoHutang += sisaBayar;
            }
        }
        
        saveDataToLocalStorage();
        cart = [];
        renderCart();
        renderProducts(); 
        renderProductTable();
        renderCustomerTable();
        updateDashboard();
        updateSalesReport();
        updatePiutangReport();
        
        paymentActionsDiv.classList.add('hidden');
        paymentActionsDiv.classList.remove('flex');
        afterPaymentActionsDiv.classList.remove('hidden');
        afterPaymentActionsDiv.classList.add('flex', 'flex-col');
    });

    printReceiptBtn.addEventListener('click', () => {
        if (lastTransactionForReceipt) {
            generateAndPrintReceipt(lastTransactionForReceipt);
        } else {
            showCustomAlert("Tidak ada data transaksi terakhir untuk dicetak.", "Info");
        }
    });

    newTransactionBtn.addEventListener('click', () => {
        paymentModal.classList.add('hidden');
        paymentActionsDiv.classList.remove('hidden');
        paymentActionsDiv.classList.add('flex');
        afterPaymentActionsDiv.classList.add('hidden');
        afterPaymentActionsDiv.classList.remove('flex', 'flex-col');
        lastTransactionForReceipt = null;
    });

    function generateAndPrintReceipt(transactionData) {
        document.getElementById('receiptShopName').textContent = appSettings.shopName;
        document.getElementById('receiptShopAddress').textContent = appSettings.shopAddress;
        document.getElementById('receiptShopPhone').textContent = appSettings.shopPhone;
        document.getElementById('receiptTransactionId').textContent = transactionData.id;
        document.getElementById('receiptDateTime').textContent = new Date(transactionData.timestamp).toLocaleString('id-ID');
        
        const customer = transactionData.pelangganId ? pelangganList.find(c => c.id === parseInt(transactionData.pelangganId)) : null;
        document.getElementById('receiptCustomerName').textContent = customer ? customer.nama : 'Pelanggan Umum';

        const itemsTableBody = document.getElementById('receiptItemsTableBody');
        itemsTableBody.innerHTML = '';
        transactionData.items.forEach(item => {
            const row = itemsTableBody.insertRow();
            row.insertCell().textContent = item.name;
            row.insertCell().textContent = item.quantity;
            row.insertCell().textContent = formatRupiah(item.price);
            row.insertCell().textContent = formatRupiah(item.price * item.quantity);
        });

        document.getElementById('receiptTotalAmount').textContent = formatRupiah(transactionData.totalAmount);
        document.getElementById('receiptAmountPaid').textContent = formatRupiah(transactionData.jumlahBayar);
        document.getElementById('receiptChangeAmount').textContent = formatRupiah(transactionData.kembalian);

        const sisaHutangRow = document.getElementById('receiptSisaHutangRow');
        if (transactionData.tipePembayaran === 'cicil' && transactionData.sisaBayar > 0) {
            document.getElementById('receiptSisaHutang').textContent = formatRupiah(transactionData.sisaBayar);
            sisaHutangRow.style.display = 'flex';
        } else {
            sisaHutangRow.style.display = 'none';
        }
        window.print();
    }


    searchInput.addEventListener('input', (e) => renderProducts(e.target.value, categoryFilterEl.value));
    categoryFilterEl.addEventListener('change', (e) => renderProducts(searchInput.value, e.target.value));

    addProductBtn.addEventListener('click', () => {
        if (productCategories.length === 0) {
            showCustomAlert("Silakan tambahkan minimal satu kategori produk terlebih dahulu melalui menu 'Kelola Kategori'.", "Peringatan");
            return;
        }
        productModalTitle.innerText = 'Tambah Produk Baru';
        productForm.reset();
        document.getElementById('productId').value = '';
        if (productCategories.length > 0) {
            productCategoryModalEl.value = productCategories[0];
        }
        document.getElementById('productIcon').value = 'üÜï'; // Default icon
        productDescriptionTextarea.value = '';
        productModal.classList.remove('hidden');
    });

    closeProductModalBtn.addEventListener('click', () => productModal.classList.add('hidden'));
    
    productForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('productId').value;
        const name = document.getElementById('productName').value;
        const category = document.getElementById('productCategoryModal').value;
        const barcode = document.getElementById('productBarcode').value.trim();
        const icon = document.getElementById('productIcon').value.trim() || 'üÜï';
        const costPrice = parseFloat(document.getElementById('productCostPrice').value);
        const price = parseFloat(document.getElementById('productPrice').value);
        const stock = parseInt(document.getElementById('productStock').value);
        const description = productDescriptionTextarea.value;

        if (costPrice > price) {
            showCustomAlert("Harga beli tidak boleh lebih besar dari harga jual.", "Error");
            return;
        }
        if (!category) {
            showCustomAlert("Kategori produk harus dipilih.", "Error");
            return;
        }

        const newProductData = {
            name: name,
            category: category,
            kodeBarcode: barcode,
            hargaBeli: costPrice,
            price: price,
            stock: stock,
            deskripsi: description,
            image: icon 
        };

        if(id) { 
            const productIndex = mockProducts.findIndex(p => p.id === parseInt(id));
            if(productIndex > -1) {
                mockProducts[productIndex] = { ...mockProducts[productIndex], ...newProductData };
            }
        } else { 
            newProductData.id = Date.now(); 
            mockProducts.unshift(newProductData);
        }
        
        saveDataToLocalStorage();
        productModal.classList.add('hidden');
        renderProductTable();
        renderProducts();
        updateDashboard(); 
        populateCategories(); 
    });

    async function callGeminiAPI(prompt, buttonElement) {
        if (buttonElement) {
            buttonElement.classList.add('gemini-btn-loading');
            buttonElement.disabled = true;
        }

        let effectiveApiKey = userProvidedGeminiApiKey; 
        if (!effectiveApiKey) {
            const envApiKey = ""; 
            effectiveApiKey = envApiKey;
        }

        if (!effectiveApiKey) {
            showCustomAlert("API Key Gemini belum diatur. Silakan masukkan API Key Anda di menu Pengaturan.", "Error");
            if (buttonElement) {
                buttonElement.classList.remove('gemini-btn-loading');
                buttonElement.disabled = false;
            }
            return "API Key tidak ditemukan.";
        }


        let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
        const payload = { contents: chatHistory };
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${effectiveApiKey}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorBody = await response.text();
                console.error("Gemini API Error Response:", errorBody);
                let displayError = `API Error ${response.status}`;
                try {
                    const parsedError = JSON.parse(errorBody);
                    if (parsedError.error && parsedError.error.message) {
                        displayError += `: ${parsedError.error.message}`;
                    }
                } catch (e) { /* Ignore parsing error, use status text */ }
                
                if (response.status === 403) {
                    displayError += " Pastikan API Key Anda valid dan memiliki izin untuk model gemini-2.0-flash.";
                } else if (response.status === 400) {
                     displayError += " Kemungkinan ada masalah dengan format permintaan atau API Key tidak valid.";
                }
                throw new Error(displayError);
            }
            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                console.error("Unexpected Gemini API response structure:", result);
                return "Tidak ada respons dari AI.";
            }
        } catch (error) {
            console.error("Error calling Gemini API:", error);
            showCustomAlert(`Gagal menghubungi AI: ${error.message}`, "Error");
            return `Gagal menghubungi AI: ${error.message}`;
        } finally {
            if (buttonElement) {
                buttonElement.classList.remove('gemini-btn-loading');
                buttonElement.disabled = false;
            }
        }
    }

    generateDescBtn.addEventListener('click', async () => {
        const productName = document.getElementById('productName').value;
        const productCategory = document.getElementById('productCategoryModal').value;
        if (!productName || !productCategory) {
            showCustomAlert("Nama produk dan kategori harus diisi untuk membuat deskripsi.", "Peringatan");
            return;
        }
        const prompt = `Buatkan deskripsi singkat dan menarik (maksimal 2 kalimat atau sekitar 150 karakter) untuk produk warung bernama "${productName}" dalam kategori "${productCategory}". Fokus pada manfaat atau keunikan produk jika memungkinkan.`;
        const generatedDescription = await callGeminiAPI(prompt, generateDescBtn);
        if (!generatedDescription.startsWith("Gagal") && !generatedDescription.startsWith("Tidak ada") && !generatedDescription.startsWith("API Key tidak")) {
            productDescriptionTextarea.value = generatedDescription;
        }
    });
    
    generatePromotionBtn.addEventListener('click', async () => {
        const bestSellingProductText = produkTerlarisEl.innerText;
        if (!bestSellingProductText || bestSellingProductText === '-') {
            showCustomAlert("Belum ada data produk terlaris untuk dibuatkan ide promosi.", "Info");
            return;
        }
        const productNameOnly = bestSellingProductText.split('(')[0].trim();

        const prompt = `Berikan 2-3 ide promosi sederhana dan kreatif untuk produk warung bernama "${productNameOnly}" untuk meningkatkan penjualan. Sampaikan dalam format daftar poin singkat.`;
        
        promotionIdeasContainer.innerHTML = `<p class="text-sm text-purple-700 animate-pulse">Meminta ide promosi dari AI...</p>`;
        generatePromotionBtn.classList.add('gemini-btn-loading');
        generatePromotionBtn.disabled = true;

        const promotionIdeas = await callGeminiAPI(prompt, null); 

        generatePromotionBtn.classList.remove('gemini-btn-loading');
        generatePromotionBtn.disabled = false;
        
        if (promotionIdeas.startsWith("Tidak ada respons") || promotionIdeas.startsWith("Gagal menghubungi AI") || promotionIdeas.startsWith("API Key tidak")) {
             promotionIdeasContainer.innerHTML = `<p class="text-sm text-red-600">${promotionIdeas}</p>`;
        } else {
            const ideasHtml = promotionIdeas.split('\n').map(idea => {
                if (idea.trim() === '') return '';
                return `<li class="text-sm text-slate-700 mb-1">${idea.replace(/^[\*\-\d\.]+\s*/, '')}</li>`;
            }).join('');
            promotionIdeasContainer.innerHTML = `
                <div class="mt-2 p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <h4 class="text-md font-semibold text-purple-800 mb-2">‚ú® Ide Promosi untuk ${productNameOnly}:</h4>
                    <ul class="list-disc list-inside pl-1">${ideasHtml}</ul>
                </div>`;
        }
    });

    function stopBarcodeScanner() {
        if (isQuaggaRunning && typeof Quagga !== 'undefined') {
            try {
                Quagga.stop();
            } catch (e) {
                console.warn("Error during Quagga.stop():", e);
            }
        }
        isQuaggaRunning = false; 

        if (barcodeScannerStream) {
            barcodeScannerStream.getTracks().forEach(track => track.stop());
            barcodeScannerStream = null;
        }
        
        barcodeScannerModal.classList.add('hidden');
        if(barcodeScannerStatusEl) barcodeScannerStatusEl.textContent = "Arahkan kamera ke barcode...";
        barcodeScanTargetInputId = null; 
    }

    function startBarcodeScanner(targetInputId = null) {
        barcodeScanTargetInputId = targetInputId; 
        barcodeScannerModal.classList.remove('hidden');
        barcodeScannerStatusEl.textContent = "Memulai kamera...";
        if (barcodeScannerViewport) barcodeScannerViewport.innerHTML = '';


        navigator.mediaDevices.getUserMedia({ video: { 
            facingMode: "environment",
            width: { ideal: 640 },
            height: { ideal: 480 }
        } })
        .then(function(stream) {
            barcodeScannerStream = stream;
            Quagga.init({
                inputStream : {
                    name : "Live",
                    type : "LiveStream",
                    target: barcodeScannerViewport, 
                    constraints: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: "environment"
                    },
                    area: { top: "20%", right: "10%", left: "10%", bottom: "20%" }
                },
                decoder : {
                    readers : ["ean_reader", "code_128_reader", "upc_reader", "ean_8_reader", "code_39_reader"],
                    multiple: false 
                },
                locate: true, 
                frequency: 10, 
            }, function(err) {
                if (err) {
                    console.error("Quagga.init error:", err);
                    barcodeScannerStatusEl.textContent = "Error memulai scanner: " + err.message;
                    showCustomAlert("Gagal menginisialisasi pemindai barcode: " + err.message, "Error Pemindai");
                    
                    if (barcodeScannerStream) { 
                        barcodeScannerStream.getTracks().forEach(track => track.stop());
                        barcodeScannerStream = null;
                    }
                    barcodeScannerModal.classList.add('hidden'); 
                    isQuaggaRunning = false; 
                    return;
                }
                barcodeScannerStatusEl.textContent = "Arahkan kamera ke barcode...";
                Quagga.start();
                isQuaggaRunning = true;
            });
        })
        .catch(function(err) {
            console.error("getUserMedia error:", err);
            barcodeScannerStatusEl.textContent = "Kamera tidak dapat diakses: " + err.name; 
            if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError") {
                 showCustomAlert("Tidak ada kamera yang ditemukan atau kamera tidak mendukung. Pastikan kamera belakang (environment) tersedia.", "Error Kamera");
            } else if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
                 showCustomAlert("Akses kamera tidak diizinkan. Harap berikan izin kamera di pengaturan browser Anda.", "Error Izin Kamera");
            } else {
                 showCustomAlert("Tidak dapat mengakses kamera: " + err.name, "Error Kamera");
            }
            barcodeScannerModal.classList.add('hidden'); 
        });
    }

    if (scanBarcodeBtn) { 
        scanBarcodeBtn.addEventListener('click', () => startBarcodeScanner(null)); 
    }
    if (scanBarcodeForProductBtn) { 
        scanBarcodeForProductBtn.addEventListener('click', () => startBarcodeScanner('productBarcode'));
    }


    Quagga.onDetected(function(result) {
        const code = result.codeResult.code;
        barcodeScannerStatusEl.textContent = "Barcode terdeteksi: " + code;
        
        if (barcodeScanTargetInputId) { 
            const targetInput = document.getElementById(barcodeScanTargetInputId);
            if (targetInput) {
                targetInput.value = code;
            }
        } else { 
            const product = mockProducts.find(p => p.kodeBarcode === code);
            if (product) {
                addToCart(product.id);
                showCustomAlert(`Produk "${product.name}" ditambahkan ke keranjang.`, "Sukses Scan");
            } else {
                showCustomAlert(`Produk dengan barcode "${code}" tidak ditemukan.`, "Produk Tidak Ditemukan");
            }
        }
        stopBarcodeScanner();
    });
    

    if(closeBarcodeScannerModalBtn) {
        closeBarcodeScannerModalBtn.addEventListener('click', stopBarcodeScanner);
    }


    const updateDashboard = () => {
        const today = new Date().toDateString();
        const todaysTransactions = dailyTransactions.filter(t => new Date(t.timestamp).toDateString() === today);
        const todaysExpenses = expensesList.filter(e => new Date(e.date).toDateString() === today);

        const totalSalesToday = todaysTransactions.reduce((sum, t) => sum + t.totalAmount, 0);
        const totalProfitToday = todaysTransactions.filter(t => t.tipePembayaran !== 'PEMBAYARAN_HUTANG').reduce((sum, t) => sum + t.profit, 0);
        const totalPiutang = pelangganList.reduce((sum, c) => sum + c.saldoHutang, 0);
        const totalExpensesToday = todaysExpenses.reduce((sum, e) => sum + e.amount, 0);
        
        if(penjualanHariIniEl) penjualanHariIniEl.innerText = formatRupiah(totalSalesToday);
        if(labaHariIniEl) labaHariIniEl.innerText = formatRupiah(totalProfitToday);
        if(totalPiutangEl) totalPiutangEl.innerText = formatRupiah(totalPiutang);
        if(transaksiHariIniEl) transaksiHariIniEl.innerText = todaysTransactions.length;
        if(pengeluaranHariIniDashboardEl) pengeluaranHariIniDashboardEl.innerText = formatRupiah(totalExpensesToday);


        const soldItemsCount = {};
        todaysTransactions.forEach(t => {
            if (t.tipePembayaran !== 'PEMBAYARAN_HUTANG') { 
                t.items.forEach(item => {
                    soldItemsCount[item.name] = (soldItemsCount[item.name] || 0) + item.quantity;
                });
            }
        });
        const sortedSoldItems = Object.entries(soldItemsCount).sort((a, b) => b[1] - a[1]);
        if(produkTerlarisEl) {
            const bestSellerText = sortedSoldItems.length > 0 ? `${sortedSoldItems[0][0]} (${sortedSoldItems[0][1]})` : '-';
            produkTerlarisEl.innerText = bestSellerText;
            generatePromotionBtn.disabled = !(sortedSoldItems.length > 0 && bestSellerText !== '-');
        }
        
        if(stokKritisListEl) {
            stokKritisListEl.innerHTML = '';
            const criticalStockProducts = mockProducts.filter(p => p.stock <= 5).sort((a,b) => a.stock - b.stock).slice(0, 5);
            if (criticalStockProducts.length > 0) {
                criticalStockProducts.forEach(p => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center text-sm';
                    li.innerHTML = `<span>${p.name}</span><span class="font-bold text-red-500">${p.stock} pcs</span>`;
                    stokKritisListEl.appendChild(li);
                });
            } else {
                stokKritisListEl.innerHTML = '<li class="text-slate-400 text-sm">Tidak ada stok kritis.</li>';
            }
        }

        if(transaksiTerakhirListEl) {
            transaksiTerakhirListEl.innerHTML = '';
            const last5Transactions = dailyTransactions.slice(-5).reverse();
            if (last5Transactions.length > 0) {
                last5Transactions.forEach(t => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center text-sm';
                    let customerName = 'Umum';
                    if (t.pelangganId) {
                        const cust = pelangganList.find(p => p.id === parseInt(t.pelangganId));
                        if (cust) customerName = cust.nama;
                    }
                    let transactionDesc = t.id;
                    if (t.tipePembayaran === 'PEMBAYARAN_HUTANG') {
                        transactionDesc = `Pembayaran Hutang (${customerName})`;
                    } else {
                        transactionDesc = `${t.id} (${customerName})`;
                    }

                    li.innerHTML = `<span>${transactionDesc}</span><span class="font-semibold ${t.tipePembayaran === 'cicil' ? 'text-amber-600' : (t.tipePembayaran === 'PEMBAYARAN_HUTANG' ? 'text-sky-600' : 'text-emerald-600')}">${formatRupiah(t.totalAmount)}</span>`;
                    transaksiTerakhirListEl.appendChild(li);
                });
            } else {
                transaksiTerakhirListEl.innerHTML = '<li class="text-slate-400 text-sm">Belum ada transaksi.</li>';
            }
        }
    };
    
    let salesTrendChartInstance;
    const renderSalesTrendChart = () => {
        const labels = [];
        const salesData = [];
        const profitData = [];

        for (let i = 6; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            labels.push(d.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric' }));
            
            const dateString = d.toDateString();
            const salesOnDate = dailyTransactions
                .filter(t => new Date(t.timestamp).toDateString() === dateString && t.tipePembayaran !== 'PEMBAYARAN_HUTANG') 
                .reduce((sum, t) => sum + t.totalAmount, 0);
            salesData.push(salesOnDate);

            const profitOnDate = dailyTransactions
                .filter(t => new Date(t.timestamp).toDateString() === dateString && t.tipePembayaran !== 'PEMBAYARAN_HUTANG') 
                .reduce((sum, t) => sum + t.profit, 0);
            profitData.push(profitOnDate);
        }

        const data = {
            labels: labels,
            datasets: [
                {
                    label: 'Penjualan',
                    data: salesData,
                    borderColor: 'rgb(37, 99, 235)',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    tension: 0.3,
                    fill: true,
                    yAxisID: 'ySales',
                },
                {
                    label: 'Laba',
                    data: profitData,
                    borderColor: 'rgb(22, 163, 74)',
                    backgroundColor: 'rgba(22, 163, 74, 0.1)',
                    tension: 0.3,
                    fill: true,
                    yAxisID: 'yProfit',
                }
            ]
        };
        if (salesTrendChartInstance) {
            salesTrendChartInstance.data = data;
            salesTrendChartInstance.update();
        } else {
            const ctx = document.getElementById('salesTrendChart').getContext('2d');
            if (!ctx) return; 
            salesTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        ySales: { 
                            type: 'linear', 
                            display: true, 
                            position: 'left',
                            beginAtZero: true, 
                            ticks: { callback: value => formatRupiah(value) } 
                        },
                        yProfit: { 
                            type: 'linear', 
                            display: true, 
                            position: 'right',
                            beginAtZero: true,
                            ticks: { callback: value => formatRupiah(value) },
                            grid: { drawOnChartArea: false } 
                        }
                    },
                    plugins: {
                        tooltip: { 
                            callbacks: { 
                                label: context => `${context.dataset.label}: ${formatRupiah(context.raw)}`
                            } 
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                }
            });
        }
    };

    let salesReportChartInstance;
    const updateSalesReport = () => {
        renderSalesTrendChart(); 

        const period = reportPeriodEl.value;
        const selectedDate = new Date(reportDateEl.value || new Date()); 
        
        let filteredTransactions = [];
        
        if (period === 'daily') {
            const dateStr = selectedDate.toDateString();
            filteredTransactions = dailyTransactions.filter(t => new Date(t.timestamp).toDateString() === dateStr);
        } else if (period === 'weekly') {
            const startOfWeek = new Date(selectedDate);
            startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay() + (selectedDate.getDay() === 0 ? -6 : 1)); 
            startOfWeek.setHours(0,0,0,0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23,59,59,999);

            filteredTransactions = dailyTransactions.filter(t => {
                const tDate = new Date(t.timestamp);
                return tDate >= startOfWeek && tDate <= endOfWeek;
            });
        } else if (period === 'monthly') {
            const year = selectedDate.getFullYear();
            const month = selectedDate.getMonth();
            filteredTransactions = dailyTransactions.filter(t => {
                const tDate = new Date(t.timestamp);
                return tDate.getFullYear() === year && tDate.getMonth() === month;
            });
        }

        const salesByCat = {};
        const profitByCat = {};
        const currentActiveCategories = [...new Set(mockProducts.map(p => p.category).concat(productCategories))].filter(Boolean).sort();


        currentActiveCategories.forEach(cat => {
            salesByCat[cat] = 0;
            profitByCat[cat] = 0;
        });

        filteredTransactions.forEach(t => {
            if (t.tipePembayaran !== 'PEMBAYARAN_HUTANG') { 
                t.items.forEach(item => {
                    if (currentActiveCategories.includes(item.category)) {
                        salesByCat[item.category] += item.price * item.quantity;
                        profitByCat[item.category] += (item.price - item.hargaBeli) * item.quantity;
                    }
                });
            }
        });
        
        const chartLabels = currentActiveCategories.length > 0 ? currentActiveCategories : ["Tidak Ada Data"];
        const chartSalesData = currentActiveCategories.length > 0 ? currentActiveCategories.map(cat => salesByCat[cat]) : [0];
        const chartProfitData = currentActiveCategories.length > 0 ? currentActiveCategories.map(cat => profitByCat[cat]) : [0];


        const chartData = {
            labels: chartLabels,
            datasets: [
                {
                    label: 'Total Penjualan',
                    data: chartSalesData,
                    backgroundColor: '#3b82f6', 
                },
                {
                    label: 'Total Laba',
                    data: chartProfitData,
                    backgroundColor: '#10b981', 
                }
            ]
        };

        if (salesReportChartInstance) {
            salesReportChartInstance.data = chartData;
            salesReportChartInstance.update();
        } else {
            const ctx = document.getElementById('salesReportChart').getContext('2d');
            if (!ctx) return;
            salesReportChartInstance = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: value => formatRupiah(value) } }
                    },
                    plugins: {
                        tooltip: { callbacks: { label: context => `${context.dataset.label}: ${formatRupiah(context.raw)}` } }
                    }
                }
            });
        }
        renderReportDetailsTable(filteredTransactions, period);
    };
    
    const renderReportDetailsTable = (transactions, period) => {
        reportDetailsTableContainerEl.innerHTML = '';
        if (transactions.length === 0) {
            reportDetailsTableContainerEl.innerHTML = `<p class="text-slate-500">Tidak ada transaksi untuk periode ${period} ini.</p>`;
            return;
        }

        const table = document.createElement('table');
        table.className = 'w-full text-left min-w-[700px]';
        table.innerHTML = `
            <thead class="bg-slate-100">
                <tr>
                    <th class="p-3 font-semibold">ID Transaksi</th>
                    <th class="p-3 font-semibold">Waktu</th>
                    <th class="p-3 font-semibold">Pelanggan</th>
                    <th class="p-3 font-semibold">Item/Deskripsi</th>
                    <th class="p-3 font-semibold">Tipe Bayar</th>
                    <th class="p-3 font-semibold text-right">Total</th>
                    <th class="p-3 font-semibold text-right">Dibayar</th>
                    <th class="p-3 font-semibold text-right">Sisa</th>
                    <th class="p-3 font-semibold text-right">Laba</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');
        transactions.forEach(t => {
            let itemsString = t.deskripsi || ''; 
            if (t.items && t.items.length > 0) {
                itemsString = t.items.map(item => `${item.name} (x${item.quantity})`).join(', ');
            }
            const customerName = t.pelangganId ? (pelangganList.find(p => p.id === parseInt(t.pelangganId))?.nama || 'N/A') : 'Umum';
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-slate-50';
            let tipeBayarDisplay = t.tipePembayaran;
            if (t.tipePembayaran === 'lunas') tipeBayarDisplay = 'Lunas';
            else if (t.tipePembayaran === 'cicil') tipeBayarDisplay = 'Cicil';
            else if (t.tipePembayaran === 'PEMBAYARAN_HUTANG') tipeBayarDisplay = 'Bayar Hutang';


            row.innerHTML = `
                <td class="p-3">${t.id}</td>
                <td class="p-3">${new Date(t.timestamp).toLocaleString('id-ID')}</td>
                <td class="p-3">${customerName}</td>
                <td class="p-3 text-sm">${itemsString}</td>
                <td class="p-3">${tipeBayarDisplay}</td>
                <td class="p-3 text-right">${formatRupiah(t.totalAmount)}</td>
                <td class="p-3 text-right">${formatRupiah(t.jumlahBayar)}</td>
                <td class="p-3 text-right ${t.sisaBayar > 0 ? 'text-red-600' : ''}">${formatRupiah(t.sisaBayar)}</td>
                <td class="p-3 text-right">${formatRupiah(t.profit)}</td>
            `;
            tbody.appendChild(row);
        });
        reportDetailsTableContainerEl.appendChild(table);
    };

    const updatePiutangReport = () => {
        piutangTableBodyEl.innerHTML = '';
        const customersWithDebt = pelangganList.filter(c => c.saldoHutang > 0);
        if (customersWithDebt.length === 0) {
            piutangTableBodyEl.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-slate-500">Tidak ada pelanggan yang memiliki hutang.</td></tr>';
            return;
        }
        customersWithDebt.forEach(c => {
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-slate-50';
            row.innerHTML = `
                <td class="p-4">${c.nama}</td>
                <td class="p-4">${c.telepon || '-'}</td>
                <td class="p-4 text-right text-red-600 font-semibold">${formatRupiah(c.saldoHutang)}</td>
            `;
            piutangTableBodyEl.appendChild(row);
        });
    };

    if (exportReportBtn) {
        exportReportBtn.addEventListener('click', () => {
            const period = reportPeriodEl.value;
            const selectedDate = new Date(reportDateEl.value || new Date());
            let transactionsToExport = [];

            if (period === 'daily') {
                const dateStr = selectedDate.toDateString();
                transactionsToExport = dailyTransactions.filter(t => new Date(t.timestamp).toDateString() === dateStr);
            } else if (period === 'weekly') {
                const startOfWeek = new Date(selectedDate);
                startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay() + (selectedDate.getDay() === 0 ? -6 : 1)); 
                startOfWeek.setHours(0,0,0,0);
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                endOfWeek.setHours(23,59,59,999);
                transactionsToExport = dailyTransactions.filter(t => {
                    const tDate = new Date(t.timestamp);
                    return tDate >= startOfWeek && tDate <= endOfWeek;
                });
            } else if (period === 'monthly') {
                const year = selectedDate.getFullYear();
                const month = selectedDate.getMonth();
                transactionsToExport = dailyTransactions.filter(t => {
                    const tDate = new Date(t.timestamp);
                    return tDate.getFullYear() === year && tDate.getMonth() === month;
                });
            }

            if (transactionsToExport.length === 0) {
                showCustomAlert("Tidak ada data transaksi untuk diekspor pada periode ini.", "Info");
                return;
            }

            const headers = ["ID Transaksi", "Waktu", "Pelanggan", "Item/Deskripsi", "Tipe Bayar", "Total", "Dibayar", "Sisa", "Laba"];
            let csvContent = headers.join(",") + "\r\n";

            transactionsToExport.forEach(t => {
                let itemsString = t.deskripsi || ''; 
                if (t.items && t.items.length > 0) {
                    itemsString = t.items.map(item => `${item.name} (x${item.quantity})`).join('; '); 
                }
                const customerName = t.pelangganId ? (pelangganList.find(p => p.id === parseInt(t.pelangganId))?.nama || 'N/A') : 'Umum';
                let tipeBayarDisplay = t.tipePembayaran;
                if (t.tipePembayaran === 'lunas') tipeBayarDisplay = 'Lunas';
                else if (t.tipePembayaran === 'cicil') tipeBayarDisplay = 'Cicil';
                else if (t.tipePembayaran === 'PEMBAYARAN_HUTANG') tipeBayarDisplay = 'Bayar Hutang';

                const row = [
                    t.id,
                    new Date(t.timestamp).toLocaleString('id-ID'),
                    `"${customerName.replace(/"/g, '""')}"`, 
                    `"${itemsString.replace(/"/g, '""')}"`, 
                    tipeBayarDisplay,
                    t.totalAmount,
                    t.jumlahBayar,
                    t.sisaBayar,
                    t.profit
                ];
                csvContent += row.join(",") + "\r\n";
            });

            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `laporan_transaksi_${period}_${selectedDate.toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        });
    }

    function renderExpenseList() {
        expenseListTableBodyEl.innerHTML = '';
        const last10Expenses = expensesList.slice().sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,10);

        if (last10Expenses.length === 0) {
            expenseListTableBodyEl.innerHTML = '<tr><td colspan="3" class="p-3 text-center text-slate-500">Belum ada pengeluaran.</td></tr>';
            return;
        }
        last10Expenses.forEach(expense => {
            const row = expenseListTableBodyEl.insertRow();
            row.className = 'border-b hover:bg-slate-50';
            row.insertCell().textContent = new Date(expense.date).toLocaleDateString('id-ID');
            row.insertCell().textContent = expense.description;
            const amountCell = row.insertCell();
            amountCell.textContent = formatRupiah(expense.amount);
            amountCell.className = 'text-right';
        });
    }

    function updateFinancialSummary() {
        const totalRevenue = dailyTransactions.reduce((sum, t) => sum + t.jumlahBayar, 0); 
        const totalExpenses = expensesList.reduce((sum, e) => sum + e.amount, 0);
        
        const totalGrossProfitFromSales = dailyTransactions
            .filter(t => t.tipePembayaran !== 'PEMBAYARAN_HUTANG') 
            .reduce((sum, t) => sum + t.profit, 0);

        const netProfit = totalGrossProfitFromSales - totalExpenses;

        if(financeTotalRevenueEl) financeTotalRevenueEl.textContent = formatRupiah(totalRevenue);
        if(financeTotalExpensesEl) financeTotalExpensesEl.textContent = formatRupiah(totalExpenses);
        if(financeNetProfitEl) financeNetProfitEl.textContent = formatRupiah(netProfit);
    }


    if (addExpenseForm) {
        addExpenseForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const date = document.getElementById('expenseDate').value;
            const description = document.getElementById('expenseDescription').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);

            if (!date || !description || isNaN(amount) || amount <= 0) {
                showCustomAlert("Tanggal, deskripsi, dan jumlah pengeluaran harus valid.", "Error");
                return;
            }
            expensesList.push({ id: Date.now(), date: new Date(date), description, amount });
            saveDataToLocalStorage();
            renderExpenseList();
            updateFinancialSummary();
            updateDashboard(); 
            addExpenseForm.reset();
            showCustomAlert("Pengeluaran berhasil dicatat.", "Sukses");
        });
    }


    reportPeriodEl.addEventListener('change', updateSalesReport);
    reportDateEl.addEventListener('change', updateSalesReport);
    reportDateEl.valueAsDate = new Date(); 

    settingsForm.addEventListener('submit', (e) => {
        e.preventDefault();
        appSettings.shopName = document.getElementById('shopName').value;
        appSettings.shopAddress = document.getElementById('shopAddress').value;
        appSettings.shopPhone = document.getElementById('shopPhone').value;
        saveDataToLocalStorage();
        settingsMessage.textContent = 'Informasi warung berhasil disimpan!';
        settingsMessage.className = 'mt-4 text-center text-green-600';
        setTimeout(() => settingsMessage.textContent = '', 3000);
    });
    
    function displayTemporaryMessage(element, message, className = "text-green-500") {
        const msgElement = document.createElement('p');
        msgElement.textContent = message;
        msgElement.className = `text-sm ${className} text-center py-1 absolute -top-6 left-0 right-0`;
        
        const originalPosition = element.style.position;
        if (originalPosition !== 'relative' && originalPosition !== 'absolute' && originalPosition !== 'fixed') {
            element.style.position = 'relative';
        }
        
        element.appendChild(msgElement);

        setTimeout(() => {
            if (msgElement.parentNode === element) {
                 element.removeChild(msgElement);
            }
            if (element.style.position === 'relative' && originalPosition !== 'relative') {
                element.style.position = originalPosition;
            }
        }, 2500);
    }

    function showCustomAlert(message, title = "Informasi") {
        const existingAlert = document.getElementById('customAlertModal');
        if (existingAlert) existingAlert.remove();

        const alertModal = document.createElement('div');
        alertModal.id = 'customAlertModal';
        alertModal.className = 'modal-backdrop';
        alertModal.innerHTML = `
            <div class="bg-white w-full max-w-sm p-6 rounded-xl shadow-lg m-4 modal-content">
                <h3 class="text-xl font-bold mb-4 text-slate-800">${title}</h3>
                <p class="text-slate-700 mb-6">${message}</p>
                <button id="customAlertOkBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition">OK</button>
            </div>
        `;
        document.body.appendChild(alertModal);
        document.getElementById('customAlertOkBtn').addEventListener('click', () => {
            alertModal.remove();
        });
        document.getElementById('customAlertOkBtn').focus();
    }

    function showCustomConfirm(message, onConfirm, title = "Konfirmasi") {
        const existingConfirm = document.getElementById('customConfirmModal');
        if (existingConfirm) existingConfirm.remove();

        const confirmModal = document.createElement('div');
        confirmModal.id = 'customConfirmModal';
        confirmModal.className = 'modal-backdrop';
        confirmModal.innerHTML = `
            <div class="bg-white w-full max-w-sm p-6 rounded-xl shadow-lg m-4 modal-content">
                <h3 class="text-xl font-bold mb-4 text-slate-800">${title}</h3>
                <p class="text-slate-700 mb-6">${message}</p>
                <div class="flex gap-4">
                    <button id="customConfirmCancelBtn" class="w-full bg-slate-200 text-slate-800 p-3 rounded-lg font-bold hover:bg-slate-300 transition">Batal</button>
                    <button id="customConfirmOkBtn" class="w-full bg-red-600 text-white p-3 rounded-lg font-bold hover:bg-red-700 transition">Ya, Lanjutkan</button>
                </div>
            </div>
        `;
        document.body.appendChild(confirmModal);
        document.getElementById('customConfirmOkBtn').addEventListener('click', () => {
            onConfirm();
            confirmModal.remove();
        });
        document.getElementById('customConfirmCancelBtn').addEventListener('click', () => {
            confirmModal.remove();
        });
         document.getElementById('customConfirmCancelBtn').focus();
    }


    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const target = link.getAttribute('data-target');

            navLinks.forEach(l => {
                l.classList.remove('active', 'bg-blue-100', 'font-semibold');
                l.classList.add('hover:bg-blue-50');
            });
            link.classList.add('active', 'bg-blue-100', 'font-semibold');
            link.classList.remove('hover:bg-blue-50');

            pageContents.forEach(page => {
                page.classList.add('hidden');
                if (page.id === target) {
                    page.classList.remove('hidden');
                    if (target === 'dashboard') updateDashboard();
                    if (target === 'laporan') {
                        updateSalesReport();
                        updatePiutangReport();
                    }
                    if (target === 'pelanggan') renderCustomerTable();
                    if (target === 'keuangan') {
                        renderExpenseList();
                        updateFinancialSummary();
                    }
                    if (target === 'pengaturan') {
                        updateLocalStorageUsageDisplay();
                        geminiApiKeyInput.value = userProvidedGeminiApiKey || ""; 
                    }
                }
            });
        });
    });
    
    // Initial Load
    loadDataFromLocalStorage(); 
    refreshAllUI(); 
});
</script>

</body>
</html>
